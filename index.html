<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <!-- === ç¤¾ç¾¤é è¦½æ¨™ç±¤ (Meta Tags) é–‹å§‹ === -->
    <title>Lumina Journey</title>
    <meta name="description" content="å°ˆå±¬ä½ çš„æ¥µç°¡ç‰Œå¡æ—¥è¨˜ã€‚çµåˆéœé‡‘æ–¯èƒ½é‡é »ç‡ã€æœˆç›¸èˆ‡ç¯€æ°£ï¼Œç´€éŒ„æ¯ä¸€æ¬¡çš„éˆæ„Ÿèˆ‡è¦ºå¯Ÿã€‚">
    
    <!-- çµ¦ LINE, Facebook, IG ç­‰ç¤¾ç¾¤è»Ÿé«”çœ‹çš„è¨­å®š -->
    <meta property="og:title" content="Lumina Journey | å¿ƒéˆç‰Œå¡æ—¥è¨˜">
    <meta property="og:description" content="å°ˆå±¬ä½ çš„æ¥µç°¡ç‰Œå¡æ—¥è¨˜ã€‚çµåˆéœé‡‘æ–¯èƒ½é‡é »ç‡ã€æœˆç›¸èˆ‡ç¯€æ°£ï¼Œæº«æŸ”åœ°ç´€éŒ„æ¯ä¸€æ¬¡çš„éˆæ„Ÿèˆ‡è¦ºå¯Ÿã€‚">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Lumina Journey">
    <!-- === ç¤¾ç¾¤é è¦½æ¨™ç±¤ (Meta Tags) çµæŸ === -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bodoni+Moda:ital,wght@0,400;0,700;1,400&display=swap');

        :root {
            --gold: #D4AF37;
            --white: #FFFFFF;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        body {
            background-color: var(--white);
            color: #2D2D2D;
            font-family: 'Bodoni Moda', 'Georgia', serif;
            margin: 0; padding: 0;
            overscroll-behavior-y: contain;
            min-height: 100vh;
        }

        .safe-pt { padding-top: calc(1.5rem + var(--safe-top)); }
        .safe-pb { padding-bottom: calc(1rem + var(--safe-bottom)); }

        .gold-text { color: var(--gold); }
        .gold-bg { background-color: var(--gold); }
        .gold-border { border: 1px solid var(--gold); }
        
        /* å‘¼å¸ç‡ˆç‰¹æ•ˆæŠ½ç‰ŒæŒ‰éˆ• */
        .btn-draw-main {
            background-color: var(--gold);
            color: white;
            box-shadow: 0 10px 30px rgba(212, 175, 55, 0.3);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(212, 175, 55, 0); }
            100% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0); }
        }

        .page-transition { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .nav-btn { font-size: 10px; letter-spacing: 0.2em; text-transform: uppercase; color: #BBB; transition: 0.3s; position: relative; }
        .nav-btn.active { color: var(--gold); font-weight: bold; }
        .nav-btn.active::after { content: ''; position: absolute; bottom: -6px; left: 0; width: 100%; height: 1px; background: var(--gold); }

        /* å¡ç‰‡è¨­è¨ˆ */
        .card-container { perspective: 1200px; width: 240px; height: 360px; }
        .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.8s cubic-bezier(0.34, 1.56, 0.64, 1); transform-style: preserve-3d; }
        .card-inner.is-flipped { transform: rotateY(180deg); }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 16px; border: 1px solid var(--gold); display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .card-back { background: linear-gradient(135deg, #fff, #fefaf0); z-index: 2; }
        .card-front { background: white; transform: rotateY(180deg); }

        /* éœé‡‘æ–¯é‡‘ç·šèª¿é »æ»‘æ¡¿ */
        .golden-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 1px;
            background: #E5E5E5;
            outline: none;
            position: relative;
        }
        .golden-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #FFFFFF;
            border: 1.5px solid var(--gold);
            box-shadow: 0 0 12px rgba(212, 175, 55, 0.4);
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.2s;
        }
        .golden-slider::-webkit-slider-thumb:active {
            transform: scale(1.3);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.6);
        }

        /* èƒ½é‡è¦–è¦ºç‰¹æ•ˆ (ç´”æ·¨èƒŒæ™¯) */
        .aura-high-row {
            background: linear-gradient(to right, rgba(212, 175, 55, 0.05), transparent 80%);
            border-left: 2px solid var(--gold) !important;
            border-radius: 0 12px 12px 0;
        }
        .aura-low-img {
            filter: grayscale(0.9) opacity(0.7);
            border-color: #E5E5E5;
        }

        .tag-chip { font-size: 9px; padding: 2px 8px; border: 0.5px solid var(--gold); border-radius: 20px; color: var(--gold); letter-spacing: 1px; display: inline-block; margin: 2px; }
        .tag-filter { font-size: 10px; padding: 6px 14px; border: 1px solid #EEE; border-radius: 20px; cursor: pointer; transition: 0.3s; color: #AAA; display: flex; align-items: center; }
        .tag-filter.active { background: var(--gold); color: white; border-color: var(--gold); }

        .input-gold { width: 100%; padding: 12px; border-bottom: 1px solid #EEE; outline: none; background: transparent; font-size: 13px; text-align: left; }
        .input-gold:focus { border-bottom-color: var(--gold); }

        .glass-modal { position: fixed; inset: 0; background: rgba(255,255,255,0.98); z-index: 100; display: flex; flex-direction: column; align-items: center; padding-top: var(--safe-top); overflow-y: auto; }
        
        ::-webkit-scrollbar { display: none; }
        
        .filter-scroll-container { display: flex; overflow-x: auto; gap: 8px; padding-bottom: 4px; width: 100%; align-items: center; scrollbar-width: none; }
        .filter-scroll-container::-webkit-scrollbar { display: none; }
        
        .toggle-switch { position: relative; width: 36px; height: 18px; background: #EEE; border-radius: 20px; transition: 0.3s; }
        .toggle-switch.on { background: var(--gold); }
        .toggle-knob { position: absolute; top: 2px; left: 2px; width: 14px; height: 14px; background: white; border-radius: 50%; transition: 0.3s; }
        .toggle-switch.on .toggle-knob { left: 20px; }
    </style>
</head>
<body class="flex flex-col items-center">

    <canvas id="sparkle-canvas" class="fixed inset-0 pointer-events-none z-50"></canvas>

    <header class="safe-pt pb-4 text-center w-full">
        <!-- é»æ“Šæ¨™é¡Œå›é¦–é  -->
        <h1 onclick="goHome()" class="text-xl tracking-[0.4em] gold-text font-bold cursor-pointer hover:opacity-80 transition active:scale-95 uppercase">LUMINA JOURNEY</h1>
        <p id="nature-status" class="text-[7px] tracking-[0.6em] mt-1 opacity-40 uppercase"></p>
    </header>

    <nav class="flex justify-center space-x-8 mb-6 w-full z-10">
        <button onclick="switchTab('draw')" id="nav-draw" class="nav-btn active">ä»Šæ—¥</button>
        <button onclick="switchTab('decks')" id="nav-decks" class="nav-btn">ç‰Œçµ„åº«</button>
        <button onclick="switchTab('history')" id="nav-history" class="nav-btn">ç´€éŒ„</button>
        <button onclick="switchTab('settings')" id="nav-settings" class="nav-btn">è¨­å®š</button>
    </nav>

    <main class="w-full max-w-md px-6 flex-grow overflow-y-auto pb-24">
        
        <!-- === æŠ½ç‰Œå€ === -->
        <section id="tab-draw" class="page-transition flex flex-col items-center">
            
            <div id="draw-ready-view" class="flex flex-col items-center mt-12 w-full">
                <p id="current-deck-name-display" class="text-[10px] gold-text tracking-[0.2em] mb-4 uppercase opacity-60">ä½¿ç”¨ä¸­ï¼šç„¡</p>
                <button onclick="startDrawRitual()" id="main-draw-btn" class="btn-draw-main w-28 h-28 rounded-full text-xs font-bold tracking-widest flex items-center justify-center transition-transform active:scale-90">
                    æŠ½ç‰Œ
                </button>
                
                <div class="flex space-x-8 mt-10">
                    <button onclick="openManualSelectModal()" class="text-[9px] opacity-40 underline tracking-widest uppercase hover:opacity-100 transition">è‡ªè¡Œé¸ç‰Œ</button>
                    <button onclick="showDeckSwitcher()" class="text-[9px] opacity-40 underline tracking-widest uppercase hover:opacity-100 transition">åˆ‡æ›ç‰Œçµ„</button>
                </div>
            </div>

            <div id="active-draw-area" class="hidden w-full flex flex-col items-center">
                <div class="card-container mb-8">
                    <div id="main-card" class="card-inner">
                        <div class="card-back"><div class="opacity-10 text-2xl">âœ§</div></div>
                        <div class="card-front"><img id="drawn-img" src="" class="w-full h-full object-cover"></div>
                    </div>
                </div>
                <div id="journal-form" class="w-full opacity-0 translate-y-4 transition-all duration-1000">
                    <h2 id="drawn-name" class="text-center italic text-lg gold-text mb-4">ç‰Œå</h2>
                    
                    <!-- éœé‡‘æ–¯èƒ½é‡èª¿é »å™¨ -->
                    <div class="w-full px-2 mb-8">
                        <div class="flex justify-between items-end mb-4">
                            <span class="text-[9px] opacity-40 uppercase tracking-widest">èƒ½é‡å…±æŒ¯é »ç‡</span>
                            <span id="hawkins-display" class="gold-text text-sm font-bold tracking-widest transition-all">200 å‹‡æ°£</span>
                        </div>
                        <div class="relative pt-2 pb-2">
                            <input type="range" id="hawkins-slider" min="0" max="16" value="8" class="golden-slider" oninput="updateHawkinsDisplay()">
                            <div class="flex justify-between mt-3 text-[7px] opacity-30 tracking-widest">
                                <span>æ”¶ç¸®</span>
                                <span>è‡¨ç•Œ</span>
                                <span>æ“´å¼µ</span>
                            </div>
                        </div>
                    </div>

                    <textarea id="diary-text" rows="4" class="w-full p-4 bg-stone-50 border-none rounded-xl text-sm focus:ring-1 focus:ring-gold mb-4" placeholder="è¨˜éŒ„ä¸‹æ­¤åˆ»çš„é »ç‡èˆ‡éˆæ„Ÿ..."></textarea>
                    <input type="text" id="tag-input" placeholder="æ¨™ç±¤ (ä»¥ç©ºæ ¼åˆ†éš”)" class="input-gold text-[11px] mb-6">
                    <div class="flex space-x-3">
                        <button onclick="askAI()" class="flex-1 py-3 border border-gold gold-text rounded-full text-[10px] tracking-widest uppercase hover:bg-stone-50 transition">AI å•Ÿè®€</button>
                        <button onclick="saveEntry()" class="flex-1 py-3 gold-bg text-white rounded-full text-[10px] tracking-widest uppercase shadow-lg hover:opacity-90 transition">å„²å­˜</button>
                    </div>
                    <p id="ai-response" class="mt-4 text-[10px] text-gray-400 italic text-center px-4 leading-relaxed"></p>
                    <button onclick="cancelDraw()" class="w-full mt-6 text-[9px] opacity-20 underline uppercase tracking-widest hover:opacity-80 transition">è¿”å›é¦–é </button>
                </div>
            </div>
        </section>

        <!-- === ç‰Œçµ„åº« === -->
        <section id="tab-decks" class="hidden page-transition">
            <div id="deck-list-view">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xs gold-text font-bold tracking-widest uppercase">ç‰Œçµ„åº«</h3>
                    <button onclick="showCreateDeck()" class="text-[10px] underline opacity-40 hover:opacity-80 transition">ï¼‹ æ–°å¢ç‰Œçµ„</button>
                </div>
                <div id="decks-container" class="space-y-4"></div>
            </div>

            <div id="deck-detail-view" class="hidden">
                <button onclick="hideDeckDetail()" class="text-[10px] opacity-30 mb-4 uppercase hover:opacity-80 transition">â† è¿”å›åˆ—è¡¨</button>
                <div class="flex justify-between items-end mb-8 border-b border-stone-100 pb-4">
                    <div>
                        <h2 id="current-deck-title" class="text-xl gold-text italic mb-1">ç‰Œçµ„</h2>
                        <button onclick="editCurrentDeck()" class="text-[9px] opacity-40 underline hover:opacity-80 transition">ä¿®æ”¹ç‰Œçµ„åç¨±</button>
                    </div>
                    <div class="flex flex-col items-end space-y-2">
                        <button onclick="uploadSingleCard()" class="px-4 py-2 gold-bg text-white rounded-full text-[10px] tracking-widest shadow-md active:scale-95 transition hover:opacity-90">
                            ï¼‹ æ–°å¢ç‰Œå¡
                        </button>
                        <button onclick="document.getElementById('batch-upload').click()" class="text-[9px] gold-text underline opacity-60 hover:opacity-100 transition">
                            æˆ–æ‰¹æ¬¡åŒ¯å…¥
                        </button>
                        <input type="file" id="batch-upload" class="hidden" accept="image/*" multiple onchange="handleBatchUpload(this)">
                    </div>
                </div>
                <div id="cards-container" class="grid grid-cols-2 gap-4"></div>
                <button onclick="deleteCurrentDeck()" class="w-full mt-20 py-4 text-[9px] text-red-300 opacity-50 uppercase tracking-widest hover:opacity-100 transition">ç§»é™¤æ•´å€‹ç‰Œçµ„</button>
            </div>
        </section>

        <!-- === æ­·å²ç´€éŒ„ === -->
        <section id="tab-history" class="hidden page-transition">
            <div id="tag-cloud" class="mb-8 w-full border-b border-stone-100 pb-4"></div>
            <div id="history-list" class="space-y-6"></div>
        </section>

        <!-- === è¨­å®šå€ === -->
        <section id="tab-settings" class="hidden page-transition space-y-6">
            <h3 class="text-xs gold-text font-bold tracking-widest uppercase mb-4">åå¥½è¨­å®š</h3>
            
            <!-- ã€æ–°å¢ï¼šAI é‡‘é‘°è¼¸å…¥å€ã€‘ -->
            <div class="flex flex-col p-4 bg-stone-50 rounded-xl space-y-3">
                <div class="flex justify-between items-start">
                    <span class="text-xs font-bold">AI å°å¸«é‡‘é‘° (API Key)</span>
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-[9px] gold-text underline">å…è²»ç²å–</a>
                </div>
                <p class="text-[9px] opacity-50 leading-relaxed">è«‹è¼¸å…¥ä½ çš„å°ˆå±¬ Gemini API Key ä»¥å•Ÿç”¨æ™ºèƒ½è§£è®€åŠŸèƒ½ã€‚é‡‘é‘°å°‡å®‰å…¨åœ°å„²å­˜åœ¨ä½ çš„æœ¬æ©Ÿè£ç½®ä¸­ã€‚</p>
                <div class="flex items-center space-x-2 mt-2">
                    <input type="password" id="api-key-setting" class="flex-grow bg-white border border-stone-200 rounded p-2 text-[10px] outline-none focus:border-gold" placeholder="è¼¸å…¥é‡‘é‘° (AIzaSy...)">
                    <button onclick="saveApiKeySetting()" class="gold-bg text-white px-3 py-2 rounded text-[10px] whitespace-nowrap hover:opacity-90 transition">å„²å­˜</button>
                </div>
            </div>

            <div class="flex items-center justify-between p-4 bg-stone-50 rounded-xl mt-4">
                <span class="text-xs font-bold">ç´€éŒ„ç•¶å‰æœˆç›¸</span>
                <div onclick="toggleSetting('showLunar')" id="set-lunar" class="toggle-switch cursor-pointer"><div class="toggle-knob"></div></div>
            </div>
            <div class="flex items-center justify-between p-4 bg-stone-50 rounded-xl">
                <span class="text-xs font-bold">ç´€éŒ„ç•¶å‰ç¯€æ°£</span>
                <div onclick="toggleSetting('showSolar')" id="set-solar" class="toggle-switch cursor-pointer"><div class="toggle-knob"></div></div>
            </div>

            <div class="pt-10 border-t border-stone-50 text-center space-y-6">
                <button onclick="exportFullData()" class="text-[10px] gold-text underline uppercase block w-full hover:opacity-80 transition">å‚™ä»½è³‡æ–™åº« (.JSON)</button>
                <button onclick="document.getElementById('import-full-file').click()" class="text-[10px] opacity-40 underline uppercase block w-full hover:opacity-80 transition">é‚„åŸè³‡æ–™åº«</button>
                <input type="file" id="import-full-file" class="hidden" accept=".json" onchange="importFullData(this)">
            </div>
        </section>

    </main>

    <!-- Modal ç³»çµ± -->
    <div id="modal-overlay" class="glass-modal hidden">
        <div id="loading-spinner" class="hidden absolute inset-0 bg-white/80 flex items-center justify-center z-[110]">
            <p class="gold-text animate-pulse text-xs tracking-widest">é­”æ³•è™•ç†ä¸­...</p>
        </div>
        <div class="w-full max-w-xs space-y-8 mt-20 px-4">
            <h3 id="modal-title" class="text-center gold-text tracking-widest uppercase text-xs">æ¨™é¡Œ</h3>
            <div id="modal-content" class="w-full"></div>
            <div class="flex space-x-4 w-full">
                <button id="modal-cancel" onclick="closeModal()" class="flex-1 py-3 text-[10px] border border-stone-200 rounded-full opacity-50 uppercase hover:opacity-80 transition">å–æ¶ˆ</button>
                <button id="modal-confirm" class="flex-1 py-3 gold-bg text-white rounded-full text-[10px] tracking-widest uppercase shadow-md hover:opacity-90 transition">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <script>
        // --- 0. Hawkins Scale Definition ---
        const hawkinsScale = [
            { v: 20, l: "ç¾æ„§" }, { v: 30, l: "å…§ç–š" }, { v: 50, l: "å†·æ¼ " },
            { v: 75, l: "æ‚²å‚·" }, { v: 100, l: "ææ‡¼" }, { v: 125, l: "æ…¾æœ›" },
            { v: 150, l: "æ†¤æ€’" }, { v: 175, l: "é©•å‚²" }, { v: 200, l: "å‹‡æ°£" },
            { v: 250, l: "æ·¡å®š" }, { v: 310, l: "ä¸»å‹•" }, { v: 350, l: "å¯¬å®¹" },
            { v: 400, l: "ç†æ™º" }, { v: 500, l: "æ„›" }, { v: 540, l: "å–œæ‚…" },
            { v: 600, l: "å¹³å’Œ" }, { v: 700, l: "é–‹æ‚Ÿ" }
        ];

        let activeHawkins = hawkinsScale[8]; // Default 200

        function updateHawkinsDisplay() {
            const slider = document.getElementById('hawkins-slider');
            activeHawkins = hawkinsScale[slider.value];
            const display = document.getElementById('hawkins-display');
            display.innerText = `${activeHawkins.v} ${activeHawkins.l}`;
            
            if (activeHawkins.v < 200) {
                display.className = "text-stone-400 text-sm font-bold tracking-widest transition-all";
            } else if (activeHawkins.v >= 500) {
                display.className = "gold-text text-sm font-bold tracking-widest transition-all";
            } else {
                display.className = "gold-text text-sm font-bold tracking-widest transition-all";
            }
        }

        // --- 1. Astronomy Logic ---
        const solarTerms = ["å°å¯’","å¤§å¯’","ç«‹æ˜¥","é›¨æ°´","é©šèŸ„","æ˜¥åˆ†","æ¸…æ˜","ç©€é›¨","ç«‹å¤","å°æ»¿","èŠ’ç¨®","å¤è‡³","å°æš‘","å¤§æš‘","ç«‹ç§‹","è™•æš‘","ç™½éœ²","ç§‹åˆ†","å¯’éœ²","éœœé™","ç«‹å†¬","å°é›ª","å¤§é›ª","å†¬è‡³"];
        function getMoonPhase(d) {
            const lp = 2551443, now = new Date(d), new_m = new Date("2000-01-06T18:14:00Z");
            const age = (((now.getTime() - new_m.getTime()) / 1000) % lp) / (24 * 3600);
            if(age < 1.84) return {n:"æ–°æœˆ",i:"ğŸŒ‘"}; if(age < 9.22) return {n:"ä¸Šå¼¦æœˆ",i:"ğŸŒ“"};
            if(age < 16.61) return {n:"æ»¿æœˆ",i:"ğŸŒ•"}; if(age < 23.99) return {n:"ä¸‹å¼¦æœˆ",i:"ğŸŒ—"};
            return {n:"çœ‰æœˆ",i:"ğŸŒ’"};
        }
        function getSolarTerm(d) {
            const y = d.getFullYear(), baseDate = new Date(1900, 0, 6, 2, 5);
            const solarTermInfo = [0, 21208, 42467, 63836, 85337, 107014, 128867, 150921, 173149, 195551, 218072, 240693, 263343, 285989, 308563, 331033, 353350, 375494, 397447, 419210, 440795, 462224, 483532, 504758];
            for(let n=23; n>=0; n--) {
                const off = 31556925974.7*(y-1900) + solarTermInfo[n]*60000;
                if(d >= new Date(baseDate.getTime()+off)) return solarTerms[n];
            }
            return solarTerms[23];
        }

        // --- 2. State, DB & API Key ---
        let db, currentDeckId = null, activeCard = null, currentFilter = { type: 'All', value: 'All' }, editingJournalId = null;
        let settings = JSON.parse(localStorage.getItem('lumina_settings') || '{"showLunar":true,"showSolar":true}');
        
        // è®€å–å­˜åœ¨æœ¬åœ°çš„ API Key
        let userApiKey = localStorage.getItem('lumina_api_key') || "";

        const request = indexedDB.open("LuminaJourneyDB_v1", 1);
        request.onupgradeneeded = e => {
            const d = e.target.result;
            d.createObjectStore("decks", {keyPath:"id", autoIncrement:true});
            d.createObjectStore("cards", {keyPath:"id", autoIncrement:true});
        };
        request.onsuccess = e => { db = e.target.result; init(); };

        async function init() {
            // åˆå§‹åŒ– API Key æ¬„ä½
            if(userApiKey) document.getElementById('api-key-setting').value = userApiKey;
            
            await ensureDefaultDeck();
            renderDecks();
            updateSettingsUI();
            updateNatureIndicator();
            switchTab('draw');
        }

        function saveApiKeySetting() {
            const key = document.getElementById('api-key-setting').value.trim();
            localStorage.setItem('lumina_api_key', key);
            userApiKey = key;
            alert("API é‡‘é‘°å·²å®‰å…¨å„²å­˜æ–¼æœ¬æ©Ÿã€‚");
        }

        async function ensureDefaultDeck() {
            const decks = await new Promise(r => db.transaction("decks").objectStore("decks").getAll().onsuccess = e => r(e.target.result));
            let savedId = localStorage.getItem('lumina_default_deck');
            if (decks.length > 0) {
                if (!savedId || !decks.find(d => d.id == savedId)) {
                    localStorage.setItem('lumina_default_deck', decks[0].id);
                }
            }
        }

        // --- 3. UI Navigation ---
        function switchTab(t) {
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('nav > button').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${t}`).classList.remove('hidden');
            document.getElementById(`nav-${t}`).classList.add('active');
            if(t==='history') { currentFilter = { type: 'All', value: 'All' }; renderHistory(); }
            if(t==='draw') updateDrawHeader();
        }

        function goHome() {
            cancelDraw();
            switchTab('draw');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function updateDrawHeader() {
            const deckId = localStorage.getItem('lumina_default_deck');
            const display = document.getElementById('current-deck-name-display');
            if (!deckId) { display.innerText = "è«‹å…ˆå»ºç«‹ç‰Œçµ„åº«"; return; }
            const deck = await new Promise(r => db.transaction("decks").objectStore("decks").get(Number(deckId)).onsuccess = e => r(e.target.result));
            display.innerText = deck ? `ä½¿ç”¨ä¸­ï¼š${deck.title}` : "è«‹é¸å–ç‰Œçµ„";
        }

        function updateSettingsUI() {
            document.getElementById('set-lunar').className = `toggle-switch cursor-pointer ${settings.showLunar?'on':''}`;
            document.getElementById('set-solar').className = `toggle-switch cursor-pointer ${settings.showSolar?'on':''}`;
        }

        function toggleSetting(k) {
            settings[k] = !settings[k];
            localStorage.setItem('lumina_settings', JSON.stringify(settings));
            updateSettingsUI(); updateNatureIndicator();
        }

        function updateNatureIndicator() {
            const now = new Date();
            let info = "";
            if(settings.showLunar) info += getMoonPhase(now).i + " " + getMoonPhase(now).n;
            if(settings.showSolar) info += (info ? " âœ§ " : "") + getSolarTerm(now);
            document.getElementById('nature-status').innerText = info || "Nature Aligned";
        }

        // --- 4. Deck Logic ---
        async function renderDecks() {
            const container = document.getElementById('decks-container');
            const decks = await new Promise(r => db.transaction("decks").objectStore("decks").getAll().onsuccess = e => r(e.target.result));
            if(decks.length === 0) { container.innerHTML = '<p class="text-center py-10 opacity-20 italic">å°šæœªæœ‰ä»»ä½•ç‰Œçµ„</p>'; return; }
            container.innerHTML = decks.map(d => `<div onclick="showDeckDetail(${d.id})" class="p-5 bg-stone-50 rounded-2xl flex justify-between items-center group active:scale-95 transition cursor-pointer hover:bg-stone-100"><div><h4 class="font-bold text-sm mb-1">${d.title}</h4><p class="text-[9px] opacity-30 uppercase tracking-widest">ç®¡ç†å…§å®¹</p></div><span class="gold-text text-xs opacity-0 group-hover:opacity-100 transition-opacity">â†’</span></div>`).join('');
        }

        function showCreateDeck() {
            openModal("å»ºç«‹ç‰Œçµ„ç¨®é¡", `<input type="text" id="deck-name-input" placeholder="ä¾‹å¦‚ï¼šå‰ç‰¹å¡”ç¾…ã€ç¥è«­å¡" class="input-gold">`, async () => {
                const title = document.getElementById('deck-name-input').value;
                if(!title) return;
                const tx = db.transaction("decks", "readwrite");
                const store = tx.objectStore("decks");
                const addReq = store.add({ title, createdAt: Date.now() });
                addReq.onsuccess = (e) => {
                    const newId = e.target.result;
                    if(!localStorage.getItem('lumina_default_deck')) localStorage.setItem('lumina_default_deck', newId);
                    closeModal();
                    showDeckDetail(newId);
                };
            });
        }

        async function showDeckDetail(id) {
            currentDeckId = id;
            document.getElementById('deck-list-view').classList.add('hidden');
            document.getElementById('deck-detail-view').classList.remove('hidden');
            const deck = await new Promise(r => db.transaction("decks").objectStore("decks").get(id).onsuccess = e => r(e.target.result));
            document.getElementById('current-deck-title').innerText = deck.title;
            renderCards();
        }

        function hideDeckDetail() { 
            document.getElementById('deck-list-view').classList.remove('hidden'); 
            document.getElementById('deck-detail-view').classList.add('hidden'); 
            renderDecks(); 
        }
        
        async function renderCards() {
            const container = document.getElementById('cards-container');
            const all = await new Promise(r => db.transaction("cards").objectStore("cards").getAll().onsuccess = e => r(e.target.result));
            const cards = all.filter(c => c.deckId === currentDeckId);
            if(cards.length === 0) { container.innerHTML = '<p class="col-span-2 text-center py-20 opacity-20 italic">æ­¤ç‰Œçµ„å…§å°šç„¡ç‰Œå¡</p>'; return; }
            container.innerHTML = cards.map(c => `<div class="relative aspect-[2/3] gold-border rounded-xl overflow-hidden shadow-sm cursor-pointer hover:shadow-md transition" onclick="editCardItem(${c.id})"><img src="${c.image}" class="w-full h-full object-cover"><div class="absolute bottom-0 w-full bg-white/80 py-2 text-[9px] text-center gold-text font-bold backdrop-blur-sm truncate px-1">${c.name}</div></div>`).join('');
        }

        async function handleBatchUpload(input) {
            const files = Array.from(input.files);
            if (files.length === 0) return;
            showLoading(true);
            const tx = db.transaction("cards", "readwrite");
            const store = tx.objectStore("cards");
            for (const file of files) {
                const name = file.name.split('.').slice(0, -1).join('.') || "æ–°ç‰Œå¡";
                const base64 = await new Promise(r => {
                    const reader = new FileReader();
                    reader.onload = e => r(e.target.result);
                    reader.readAsDataURL(file);
                });
                store.add({ deckId: currentDeckId, name, image: base64 });
            }
            tx.oncomplete = () => { showLoading(false); renderCards(); input.value = ''; };
        }

        function uploadSingleCard() {
            openModal("æ–°å¢å–®å¼µç‰Œå¡", `<input type="text" id="card-name-input" placeholder="ç‰Œå¡åç¨±" class="input-gold"><input type="file" id="card-file-input" accept="image/*" class="text-[10px] opacity-40 mt-4 w-full">`, async () => {
                const name = document.getElementById('card-name-input').value, file = document.getElementById('card-file-input').files[0];
                if(!name || !file) return;
                const reader = new FileReader();
                reader.onload = e => {
                    const tx = db.transaction("cards", "readwrite");
                    tx.objectStore("cards").add({ deckId: currentDeckId, name, image: e.target.result });
                    tx.oncomplete = () => { closeModal(); renderCards(); };
                };
                reader.readAsDataURL(file);
            });
        }

        async function editCardItem(id) {
            const card = await new Promise(r => db.transaction("cards").objectStore("cards").get(id).onsuccess = e => r(e.target.result));
            openModal("ç·¨è¼¯ç‰Œå¡", `<div class="flex flex-col items-center"><img src="${card.image}" class="w-20 h-30 object-cover rounded mb-4 gold-border"><input type="text" id="edit-card-name" value="${card.name}" class="input-gold"><button onclick="deleteCardItem(${id})" class="mt-6 text-[9px] text-red-300 opacity-50 uppercase underline hover:opacity-100 transition">ç§»é™¤æ­¤å¼µç‰Œå¡</button></div>`, async () => {
                const newName = document.getElementById('edit-card-name').value;
                const tx = db.transaction("cards", "readwrite");
                tx.objectStore("cards").put({ ...card, name: newName });
                tx.oncomplete = () => { closeModal(); renderCards(); };
            });
        }

        function deleteCardItem(id) { 
            if(confirm("ç¢ºå®šç§»é™¤æ­¤å¡ï¼Ÿ")) { 
                const tx = db.transaction("cards", "readwrite"); 
                tx.objectStore("cards").delete(id); 
                tx.oncomplete = () => { closeModal(); renderCards(); }; 
            } 
        }

        async function editCurrentDeck() {
            const deck = await new Promise(r => db.transaction("decks").objectStore("decks").get(currentDeckId).onsuccess = e => r(e.target.result));
            openModal("ä¿®æ”¹ç‰Œçµ„åç¨±", `<input type="text" id="edit-deck-name" value="${deck.title}" class="input-gold">`, async () => {
                const newTitle = document.getElementById('edit-deck-name').value;
                if(!newTitle) return;
                const tx = db.transaction("decks", "readwrite");
                tx.objectStore("decks").put({ ...deck, title: newTitle });
                tx.oncomplete = () => { document.getElementById('current-deck-title').innerText = newTitle; updateDrawHeader(); closeModal(); };
            });
        }

        async function deleteCurrentDeck() {
            if(!confirm("ç¢ºå®šåˆªé™¤æ•´å€‹ç‰Œçµ„åŠå…¶æ‰€æœ‰ç‰Œå¡å—ï¼Ÿé€™é …æ“ä½œç„¡æ³•å¾©åŸã€‚")) return;
            const tx = db.transaction(["decks", "cards"], "readwrite");
            tx.objectStore("decks").delete(currentDeckId);
            const cardStore = tx.objectStore("cards");
            const all = await new Promise(r => cardStore.getAll().onsuccess = e => r(e.target.result));
            all.filter(c => c.deckId === currentDeckId).forEach(c => cardStore.delete(c.id));
            
            tx.oncomplete = () => {
                if(localStorage.getItem('lumina_default_deck') == currentDeckId) localStorage.removeItem('lumina_default_deck');
                hideDeckDetail();
            };
        }

        // --- 5. Draw Logic ---
        async function showDeckSwitcher() {
            const decks = await new Promise(r => db.transaction("decks").objectStore("decks").getAll().onsuccess = e => r(e.target.result));
            if(decks.length === 0) return alert("è«‹å…ˆå»ºç«‹ç‰Œçµ„ï¼");
            openModal("åˆ‡æ›ä½¿ç”¨ç‰Œçµ„", `<div class="space-y-2 w-full max-h-[50vh] overflow-y-auto pr-2">${decks.map(d => `<button onclick="setDefaultDeck(${d.id})" class="w-full py-3 border border-stone-100 rounded-xl text-xs hover:border-gold hover:text-gold transition">${d.title}</button>`).join('')}</div>`, null);
        }
        function setDefaultDeck(id) { localStorage.setItem('lumina_default_deck', id); updateDrawHeader(); closeModal(); }

        async function startDrawRitual() {
            const deckId = localStorage.getItem('lumina_default_deck');
            if(!deckId) return alert("è«‹å…ˆåœ¨ç‰Œçµ„åº«å»ºç«‹ç‰Œå¡ï¼");
            const all = await new Promise(r => db.transaction("cards").objectStore("cards").getAll().onsuccess = e => r(e.target.result));
            const deckCards = all.filter(c => c.deckId == deckId);
            if(deckCards.length === 0) return alert("æ­¤ç‰Œçµ„å…§å°šæœªæ–°å¢ç…§ç‰‡å–”ï¼");
            
            activeCard = deckCards[Math.floor(Math.random() * deckCards.length)];
            prepareRecordView(true);
        }

        async function openManualSelectModal() {
            const deckId = localStorage.getItem('lumina_default_deck');
            if(!deckId) return alert("è«‹å…ˆå»ºç«‹ç‰Œçµ„ï¼");
            const all = await new Promise(r => db.transaction("cards").objectStore("cards").getAll().onsuccess = e => r(e.target.result));
            const deckCards = all.filter(c => c.deckId == deckId);
            if(deckCards.length === 0) return alert("æ­¤ç‰Œçµ„å…§å°šæœªæ–°å¢ç…§ç‰‡å–”ï¼");
            
            const gridHtml = `
                <div class="grid grid-cols-3 gap-3 max-h-[60vh] overflow-y-auto p-1 w-full">
                    ${deckCards.map(c => `
                        <div onclick='selectManualCard(${JSON.stringify(c).replace(/'/g, "&apos;")})' class="cursor-pointer hover:opacity-80 transition active:scale-95">
                            <img src="${c.image}" class="w-full aspect-[2/3] object-cover rounded-lg gold-border shadow-sm">
                            <p class="text-[8px] text-center mt-1 truncate gold-text">${c.name}</p>
                        </div>
                    `).join('')}
                </div>`;
            openModal("è‡ªè¡Œé¸ç‰Œç´€éŒ„", gridHtml, null);
        }

        function selectManualCard(card) {
            closeModal();
            activeCard = card;
            prepareRecordView(false);
        }

        function prepareRecordView(isRandomDraw) {
            document.getElementById('drawn-img').src = activeCard.image;
            document.getElementById('drawn-name').innerText = activeCard.name;
            document.getElementById('diary-text').value = "";
            document.getElementById('tag-input').value = "";
            document.getElementById('ai-response').innerText = "";
            
            // é‡ç½®æ»‘æ¡¿åˆ° 200 å‹‡æ°£ (index 8)
            document.getElementById('hawkins-slider').value = 8;
            updateHawkinsDisplay();
            
            document.getElementById('draw-ready-view').classList.add('hidden');
            document.getElementById('active-draw-area').classList.remove('hidden');
            
            const mainCard = document.getElementById('main-card');
            const journalForm = document.getElementById('journal-form');
            
            if(isRandomDraw) {
                mainCard.classList.remove('is-flipped');
                journalForm.classList.add('opacity-0', 'translate-y-4');
                setTimeout(() => flipCard(), 150);
            } else {
                mainCard.classList.add('is-flipped');
                journalForm.classList.remove('opacity-0', 'translate-y-4');
            }
        }

        function flipCard() { 
            const el = document.getElementById('main-card'); 
            if(el.classList.contains('is-flipped')) return; 
            el.classList.add('is-flipped'); 
            triggerSparkles(); 
            setTimeout(() => document.getElementById('journal-form').classList.remove('opacity-0', 'translate-y-4'), 600); 
        }

        function cancelDraw() { 
            editingJournalId = null;
            document.getElementById('draw-ready-view').classList.remove('hidden'); 
            document.getElementById('active-draw-area').classList.add('hidden'); 
            document.getElementById('main-card').classList.remove('is-flipped');
            document.getElementById('journal-form').classList.add('opacity-0', 'translate-y-4');
        }

        // --- 6. Hawkins Storage & History ---
        async function saveEntry() {
            const content = document.getElementById('diary-text').value;
            const tagVal = document.getElementById('tag-input').value;
            if(!content) return alert("è«‹å¯«ä¸‹ä½ çš„éˆæ„Ÿæˆ–æ„Ÿæ‚Ÿ");
            
            const now = new Date();
            const tags = tagVal.split(/[\s,ï¼Œ]+/).filter(t => t.trim() !== "");
            
            const entry = {
                id: editingJournalId || Date.now(), 
                cardName: activeCard.name, 
                cardImg: activeCard.image,
                content: content, 
                tags: tags,
                hawkins: activeHawkins,
                ai: document.getElementById('ai-response').innerText,
                date: now.toLocaleString('zh-TW', { hour12: false }),
                lunar: settings.showLunar ? getMoonPhase(now) : null, 
                solar: settings.showSolar ? getSolarTerm(now) : null
            };
            
            const history = JSON.parse(localStorage.getItem('lumina_history') || '[]');
            if(editingJournalId) {
                const idx = history.findIndex(h => h.id === editingJournalId);
                if(idx !== -1) history[idx] = entry;
                editingJournalId = null;
            } else { history.unshift(entry); }
            
            localStorage.setItem('lumina_history', JSON.stringify(history));
            alert("æ„Ÿæ‚Ÿå·²å„²å­˜ã€‚");
            cancelDraw();
            switchTab('history');
        }

        function renderHistory() {
            const history = JSON.parse(localStorage.getItem('lumina_history') || '[]');
            const list = document.getElementById('history-list');
            const cloud = document.getElementById('tag-cloud');
            
            const moonsMap = {};
            const tagCounts = {};
            history.forEach(h => {
                if(h.lunar) moonsMap[h.lunar.n] = h.lunar.i;
                (h.tags || []).forEach(t => tagCounts[t] = (tagCounts[t] || 0) + 1);
            });
            
            const availableMoons = Object.keys(moonsMap);
            const topTags = Object.entries(tagCounts).sort((a,b) => b[1] - a[1]).slice(0, 3).map(e => e[0]);
            
            let cloudHtml = `<button onclick="filterBy('All', 'All')" class="tag-filter whitespace-nowrap flex-shrink-0 ${currentFilter.type==='All'?'active':''} hover:bg-gold hover:text-white transition">å…¨éƒ¨ç´€éŒ„</button>`;
            
            if (availableMoons.length > 0) {
                cloudHtml += `<div class="w-px h-3 bg-stone-200 flex-shrink-0 mx-1"></div>`;
                cloudHtml += availableMoons.map(m => `<button onclick="filterBy('moon', '${m}')" class="tag-filter whitespace-nowrap flex-shrink-0 ${currentFilter.type==='moon' && currentFilter.value===m ?'active':''} hover:bg-gold hover:text-white transition">${moonsMap[m]} ${m}</button>`).join('');
            }
            if (topTags.length > 0) {
                cloudHtml += `<div class="w-px h-3 bg-stone-200 flex-shrink-0 mx-1"></div>`;
                cloudHtml += topTags.map(t => `<button onclick="filterBy('tag', '${t}')" class="tag-filter whitespace-nowrap flex-shrink-0 ${currentFilter.type==='tag' && currentFilter.value===t ?'active':''} hover:bg-gold hover:text-white transition">#${t}</button>`).join('');
            }
            
            cloud.innerHTML = `<p class="text-[8px] opacity-30 tracking-widest mb-3 uppercase text-center w-full">æ´å¯Ÿç¯©é¸å™¨</p><div class="filter-scroll-container">${cloudHtml}</div>`;

            const filtered = currentFilter.type === 'All' ? history :
                             currentFilter.type === 'moon' ? history.filter(h => h.lunar && h.lunar.n === currentFilter.value) :
                             history.filter(h => (h.tags || []).includes(currentFilter.value));

            if(filtered.length === 0) { list.innerHTML = '<p class="text-center py-20 opacity-20 italic">å°šç„¡ç›¸é—œç´€éŒ„</p>'; return; }
            
            list.innerHTML = filtered.map(h => {
                const natureInfo = [(h.lunar ? `${h.lunar.i} ${h.lunar.n}` : ""), (h.solar ? `âœ§ ${h.solar}` : "")].filter(Boolean).join(" ");
                
                let auraImgClass = "border-stone-200";
                let auraRowClass = "border-stone-100 pl-4";
                let textClass = "gold-text";

                if (h.hawkins.v < 200) {
                    auraImgClass = "aura-low-img";
                    textClass = "text-stone-400";
                } else if (h.hawkins.v >= 500) {
                    auraImgClass = "border-gold"; 
                    auraRowClass = "aura-high-row pl-3"; 
                    textClass = "gold-text";
                }

                return `
                <div class="flex space-x-4 relative animate-fade-in border-l ${auraRowClass} py-2 pr-2">
                    
                    <div class="w-16 flex-shrink-0 flex flex-col items-center">
                        <img src="${h.cardImg}" class="w-full h-24 object-cover rounded-lg border transition-all duration-500 shadow-sm ${auraImgClass}">
                        <span class="${textClass} text-[9px] font-bold mt-2 text-center leading-tight w-full break-words">${h.cardName}</span>
                    </div>

                    <div class="flex-grow pt-1">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex flex-col text-[9px] opacity-40 space-y-0.5">
                                <span>${h.date}</span>
                                <span>${natureInfo}</span>
                            </div>
                            <button onclick="editJournalEntry(${h.id})" class="text-[11px] opacity-20 hover:opacity-100 hover:text-gold transition px-1 cursor-pointer" title="ç·¨è¼¯ç´€éŒ„">âœ</button>
                        </div>
                        
                        <p class="text-[9px] opacity-50 tracking-widest mb-1.5 flex items-center">
                            <span class="mr-1 opacity-70">èƒ½é‡:</span> 
                            <span class="${textClass} font-bold">${h.hawkins.v} ${h.hawkins.l}</span>
                        </p>
                        
                        <p class="text-xs text-stone-600 leading-relaxed mb-2">${h.content}</p>
                        <div class="mb-2">${(h.tags || []).map(t => `<span class="tag-chip">#${t}</span>`).join('')}</div>
                        ${h.ai ? `<div class="bg-stone-50 p-2 rounded text-[9px] italic text-stone-400 mb-1 leading-relaxed">AI å°å¸«ï¼š${h.ai}</div>` : ''}
                    </div>
                </div>
                `;
            }).join('');
        }

        function filterBy(type, value) { currentFilter = { type, value }; renderHistory(); }

        async function editJournalEntry(id) {
            const history = JSON.parse(localStorage.getItem('lumina_history') || '[]');
            const entry = history.find(h => h.id === id);
            editingJournalId = id; 
            activeCard = { name: entry.cardName, image: entry.cardImg };
            
            document.getElementById('diary-text').value = entry.content;
            document.getElementById('tag-input').value = (entry.tags || []).join(' ');
            document.getElementById('drawn-img').src = entry.cardImg;
            document.getElementById('drawn-name').innerText = entry.cardName;
            document.getElementById('ai-response').innerText = entry.ai || "";
            
            let sIdx = hawkinsScale.findIndex(x => x.v === entry.hawkins.v);
            document.getElementById('hawkins-slider').value = sIdx !== -1 ? sIdx : 8;
            updateHawkinsDisplay();
            
            switchTab('draw');
            document.getElementById('draw-ready-view').classList.add('hidden');
            document.getElementById('active-draw-area').classList.remove('hidden');
            document.getElementById('main-card').classList.add('is-flipped');
            document.getElementById('journal-form').classList.remove('opacity-0', 'translate-y-4');
        }

        // --- 7. AI & Modals (with Custom Key Check) ---
        async function askAI() {
            if (!userApiKey) {
                alert("å®‡å®™çš„è¯ç¹«éœ€è¦ä¸€æŠŠé‘°åŒ™ã€‚\n\nè«‹å…ˆå‰å¾€ã€Œè¨­å®šã€é é¢ï¼Œè¼¸å…¥æ‚¨çš„ Gemini API Key ä¾†å–šé†’ AI å°å¸«ã€‚");
                switchTab('settings');
                return;
            }

            const box = document.getElementById('ai-response'); 
            box.innerText = "æ­£åœ¨æ„Ÿæ‡‰æ˜Ÿè¾°...";
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userApiKey}`, {
                    method:'POST', body: JSON.stringify({contents:[{parts:[{text:`ä½ æ˜¯ä¸€ä½å„ªé›…çš„å¿ƒéˆå°å¸«ã€‚ä½¿ç”¨è€…åœ¨éœé‡‘æ–¯èƒ½é‡å±¤ç´š ${activeHawkins.v} (${activeHawkins.l}) çš„ç‹€æ…‹ä¸‹æŠ½åˆ°äº†ã€Œ${activeCard.name}ã€ã€‚è«‹çµ¦ä¸€æ®µç´„ 60 å­—çš„æº«æš–å•Ÿç™¼ã€‚`}]}]})
                });
                
                if (!res.ok) {
                    throw new Error("API Key ç„¡æ•ˆæˆ–é¡åº¦å·²æ»¿");
                }

                const data = await res.json();
                box.innerText = data.candidates?.[0]?.content?.parts?.[0]?.text || "è†è½ä½ çš„ç›´è¦ºï¼Œç•¶ä¸‹å³æ˜¯ç­”æ¡ˆã€‚";
            } catch(e) { 
                box.innerText = "å®‡å®™æš«æ™‚éœé»˜ï¼Œè«‹ç¢ºèªæ‚¨çš„ API Key æ˜¯å¦æ­£ç¢ºã€‚"; 
            }
        }

        function openModal(title, content, confirmFn) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-content').innerHTML = content;
            const confirmBtn = document.getElementById('modal-confirm');
            const cancelBtn = document.getElementById('modal-cancel');
            
            if (confirmFn) {
                confirmBtn.onclick = confirmFn;
                confirmBtn.classList.remove('hidden');
                cancelBtn.innerText = "å–æ¶ˆ";
            } else {
                confirmBtn.classList.add('hidden');
                cancelBtn.innerText = "é—œé–‰";
            }
            document.getElementById('modal-overlay').classList.remove('hidden');
        }
        function closeModal() { document.getElementById('modal-overlay').classList.add('hidden'); }
        function showLoading(show) { document.getElementById('loading-spinner').classList.toggle('hidden', !show); }

        function triggerSparkles() {
            const canvas = document.getElementById('sparkle-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            let particles = [];
            for(let i=0; i<40; i++) particles.push({x:window.innerWidth/2, y:window.innerHeight/3, vx:(Math.random()-0.5)*12, vy:(Math.random()-0.5)*12, s:Math.random()*2.5, a:1});
            function anim() {
                ctx.clearRect(0,0,canvas.width,canvas.height);
                particles.forEach((p,i) => {
                    p.x+=p.vx; p.y+=p.vy; p.a-=0.02; ctx.fillStyle=`rgba(212,175,55,${p.a})`;
                    ctx.beginPath(); ctx.arc(p.x, p.y, p.s, 0, Math.PI*2); ctx.fill();
                    if(p.a<=0) particles.splice(i,1);
                });
                if(particles.length > 0) requestAnimationFrame(anim);
            }
            anim();
        }

        async function exportFullData() {
            showLoading(true);
            const decks = await new Promise(r => db.transaction("decks").objectStore("decks").getAll().onsuccess = e => r(e.target.result));
            const cards = await new Promise(r => db.transaction("cards").objectStore("cards").getAll().onsuccess = e => r(e.target.result));
            const history = JSON.parse(localStorage.getItem('lumina_history') || '[]');
            const blob = new Blob([JSON.stringify({ decks, cards, history })], { type: "application/json" });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `lumina_journey_backup_${Date.now()}.json`; a.click();
            showLoading(false);
        }

        function importFullData(input) {
            if(!input.files[0]) return;
            showLoading(true);
            const r = new FileReader();
            r.onload = async e => {
                try {
                    const data = JSON.parse(e.target.result);
                    const tx = db.transaction(["decks", "cards"], "readwrite");
                    if(data.decks) data.decks.forEach(d => tx.objectStore("decks").put(d));
                    if(data.cards) data.cards.forEach(c => tx.objectStore("cards").put(c));
                    if(data.history) localStorage.setItem('lumina_history', JSON.stringify(data.history));
                    tx.oncomplete = () => {
                        showLoading(false);
                        alert("è³‡æ–™é‚„åŸæˆåŠŸï¼");
                        location.reload();
                    };
                } catch(err) {
                    showLoading(false);
                    alert("æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼Œé‚„åŸå¤±æ•—ã€‚");
                }
            };
            r.readAsText(input.files[0]);
        }
    </script>
</body>
</html>




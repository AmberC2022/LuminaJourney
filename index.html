<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- === ç¤¾ç¾¤é è¦½æ¨™ç±¤ === -->
    <title>Lumina Journey</title>
    <meta name="description" content="å°ˆå±¬ä½ çš„æ¥µç°¡ç‰Œå¡æ—¥è¨˜ã€‚çµåˆéœé‡‘æ–¯èƒ½é‡é »ç‡ã€æœˆç›¸èˆ‡ç¯€æ°£ï¼Œç´€éŒ„æ¯ä¸€æ¬¡çš„éˆæ„Ÿèˆ‡è¦ºå¯Ÿã€‚">
    <meta property="og:title" content="Lumina Journey | å¿ƒéˆç‰Œå¡æ—¥è¨˜">
    <meta property="og:description" content="å°ˆå±¬ä½ çš„æ¥µç°¡ç‰Œå¡æ—¥è¨˜ã€‚çµåˆéœé‡‘æ–¯èƒ½é‡é »ç‡ã€æœˆç›¸èˆ‡ç¯€æ°£ï¼Œæº«æŸ”åœ°ç´€éŒ„æ¯ä¸€æ¬¡çš„éˆæ„Ÿèˆ‡è¦ºå¯Ÿã€‚">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Lumina Journey">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bodoni+Moda:ital,wght@0,400;0,700;1,400&display=swap');

        :root {
            --gold: #D4AF37;
            --white: #FFFFFF;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        body {
            background-color: var(--white);
            color: #2D2D2D;
            font-family: 'Bodoni Moda', 'Georgia', serif;
            margin: 0; padding: 0;
            overscroll-behavior-y: contain;
            min-height: 100vh;
            line-height: 1.6; 
        }

        .safe-pt { padding-top: calc(1.5rem + var(--safe-top)); }
        .safe-pb { padding-bottom: calc(1rem + var(--safe-bottom)); }

        .gold-text { color: var(--gold); }
        .gold-bg { background-color: var(--gold); }
        .gold-border { border: 1px solid var(--gold); }
        
        /* å‘¼å¸ç‡ˆç‰¹æ•ˆæŠ½ç‰ŒæŒ‰éˆ• */
        .btn-draw-main {
            background-color: var(--gold);
            color: white;
            box-shadow: 0 10px 30px rgba(212, 175, 55, 0.3);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.4); }
            70% { box-shadow: 0 0 0 20px rgba(212, 175, 55, 0); }
            100% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0); }
        }

        .page-transition { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .nav-btn { font-size: 12px; letter-spacing: 0.15em; text-transform: uppercase; color: #BBB; transition: 0.3s; position: relative; padding: 0.5rem; }
        @media (min-width: 768px) { .nav-btn { font-size: 14px; letter-spacing: 0.2em; } }
        .nav-btn.active { color: var(--gold); font-weight: bold; }
        .nav-btn.active::after { content: ''; position: absolute; bottom: 0px; left: 10%; width: 80%; height: 1px; background: var(--gold); }

        /* å¡ç‰‡è¨­è¨ˆè‡ªé©æ‡‰ */
        .card-container { perspective: 1200px; width: 240px; height: 360px; }
        @media (min-width: 768px) { .card-container { width: 300px; height: 450px; } }
        .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.8s cubic-bezier(0.34, 1.56, 0.64, 1); transform-style: preserve-3d; }
        .card-inner.is-flipped { transform: rotateY(180deg); }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 16px; border: 1px solid var(--gold); display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .card-back { background: linear-gradient(135deg, #fff, #fefaf0); z-index: 2; }
        .card-front { background: white; transform: rotateY(180deg); }

        .golden-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 1px;
            background: #E5E5E5;
            outline: none;
            position: relative;
        }
        .golden-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #FFFFFF;
            border: 1.5px solid var(--gold);
            box-shadow: 0 0 12px rgba(212, 175, 55, 0.4);
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.2s;
        }
        .golden-slider::-webkit-slider-thumb:active {
            transform: scale(1.3);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.6);
        }

        .aura-high-row {
            background: linear-gradient(to right, rgba(212, 175, 55, 0.05), transparent 80%);
            border-left: 3px solid var(--gold) !important;
            border-radius: 0 12px 12px 0;
        }
        .aura-low-img {
            filter: grayscale(0.9) opacity(0.7);
            border-color: #E5E5E5;
        }

        .tag-chip { font-size: 11px; padding: 4px 10px; border: 0.5px solid var(--gold); border-radius: 20px; color: var(--gold); letter-spacing: 1px; display: inline-block; margin: 3px; }
        @media (min-width: 768px) { .tag-chip { font-size: 12px; } }
        .tag-filter { font-size: 12px; padding: 8px 16px; border: 1px solid #EEE; border-radius: 20px; cursor: pointer; transition: 0.3s; color: #AAA; display: flex; align-items: center; }
        @media (min-width: 768px) { .tag-filter { font-size: 14px; } }
        .tag-filter.active { background: var(--gold); color: white; border-color: var(--gold); }

        /* é˜² iOS æ”¾å¤§ */
        .input-gold { width: 100%; padding: 16px; border-bottom: 1px solid #EEE; outline: none; background: transparent; font-size: 16px; text-align: left; transition: 0.3s; }
        .input-gold:focus { border-bottom-color: var(--gold); }

        .glass-modal { position: fixed; inset: 0; background: rgba(255,255,255,0.98); z-index: 100; display: flex; flex-direction: column; align-items: center; padding-top: var(--safe-top); overflow-y: auto; }
        
        ::-webkit-scrollbar { display: none; }
        
        .filter-scroll-container { display: flex; overflow-x: auto; gap: 10px; padding-bottom: 6px; width: 100%; align-items: center; scrollbar-width: none; }
        .filter-scroll-container::-webkit-scrollbar { display: none; }
        
        .toggle-switch { position: relative; width: 44px; height: 22px; background: #EEE; border-radius: 20px; transition: 0.3s; }
        .toggle-switch.on { background: var(--gold); }
        .toggle-knob { position: absolute; top: 3px; left: 3px; width: 16px; height: 16px; background: white; border-radius: 50%; transition: 0.3s; }
        .toggle-switch.on .toggle-knob { left: 25px; }
    </style>
</head>
<body class="flex flex-col items-center">

    <canvas id="sparkle-canvas" class="fixed inset-0 pointer-events-none z-50"></canvas>

    <header class="safe-pt pb-6 text-center w-full">
        <h1 onclick="goHome()" class="text-2xl md:text-3xl tracking-[0.4em] gold-text font-bold cursor-pointer hover:opacity-80 transition active:scale-95 uppercase">LUMINA JOURNEY</h1>
        <p id="nature-status" class="text-[10px] md:text-xs tracking-[0.6em] mt-2 opacity-40 uppercase"></p>
    </header>

    <nav class="flex justify-center space-x-6 md:space-x-12 mb-8 w-full z-10">
        <button onclick="switchTab('draw')" id="nav-draw" class="nav-btn active">ä»Šæ—¥</button>
        <button onclick="switchTab('decks')" id="nav-decks" class="nav-btn">ç‰Œçµ„åº«</button>
        <button onclick="switchTab('history')" id="nav-history" class="nav-btn">ç´€éŒ„</button>
        <button onclick="switchTab('settings')" id="nav-settings" class="nav-btn">è¨­å®š</button>
    </nav>

    <main class="w-full max-w-md md:max-w-2xl px-6 flex-grow overflow-y-auto pb-24">
        
        <!-- === æŠ½ç‰Œå€ === -->
        <section id="tab-draw" class="page-transition flex flex-col items-center">
            
            <div id="draw-empty-state" class="flex flex-col items-center mt-16 md:mt-24 w-full text-center hidden">
                <!-- å…§å®¹å‹•æ…‹å¯«å…¥ -->
            </div>

            <div id="draw-ready-view" class="flex flex-col items-center mt-12 md:mt-20 w-full hidden">
                <p id="current-deck-name-display" class="text-xs md:text-sm gold-text tracking-[0.2em] mb-6 md:mb-8 uppercase opacity-60">ä½¿ç”¨ä¸­ï¼šç„¡</p>
                <button onclick="startDrawRitual()" id="main-draw-btn" class="btn-draw-main w-32 h-32 md:w-40 md:h-40 rounded-full text-sm md:text-base font-bold tracking-widest flex items-center justify-center transition-transform active:scale-90">
                    æŠ½ç‰Œ
                </button>
                
                <div class="flex space-x-10 mt-12 md:mt-16">
                    <button onclick="openManualSelectModal()" class="text-xs md:text-sm opacity-50 underline tracking-widest uppercase hover:opacity-100 hover:text-gold transition p-2">è‡ªè¡Œé¸ç‰Œ</button>
                    <button onclick="showDeckSwitcher()" class="text-xs md:text-sm opacity-50 underline tracking-widest uppercase hover:opacity-100 hover:text-gold transition p-2">åˆ‡æ›ç‰Œçµ„</button>
                </div>
            </div>

            <div id="active-draw-area" class="hidden w-full flex flex-col items-center">
                <div class="card-container mb-10">
                    <div id="main-card" class="card-inner">
                        <div class="card-back"><div class="opacity-10 text-4xl">âœ§</div></div>
                        <div class="card-front"><img id="drawn-img" src="" class="w-full h-full object-cover"></div>
                    </div>
                </div>
                <div id="journal-form" class="w-full opacity-0 translate-y-4 transition-all duration-1000 max-w-lg">
                    <h2 id="drawn-name" class="text-center italic text-xl md:text-2xl gold-text mb-6">ç‰Œå</h2>
                    
                    <div class="w-full px-2 mb-10">
                        <div class="flex justify-between items-end mb-5">
                            <span class="text-xs md:text-sm opacity-50 uppercase tracking-widest">èƒ½é‡å…±æŒ¯é »ç‡</span>
                            <span id="hawkins-display" class="gold-text text-base md:text-lg font-bold tracking-widest transition-all">200 å‹‡æ°£</span>
                        </div>
                        <div class="relative pt-2 pb-2">
                            <input type="range" id="hawkins-slider" min="0" max="16" value="8" class="golden-slider" oninput="updateHawkinsDisplay()">
                            <div class="flex justify-between mt-4 text-[10px] md:text-xs opacity-40 tracking-widest">
                                <span>æ”¶ç¸®</span>
                                <span>è‡¨ç•Œ</span>
                                <span>æ“´å¼µ</span>
                            </div>
                        </div>
                    </div>

                    <textarea id="diary-text" rows="5" class="w-full p-5 bg-stone-50 border-none rounded-xl text-base focus:ring-1 focus:ring-gold mb-5 leading-loose" placeholder="è¨˜éŒ„ä¸‹æ­¤åˆ»çš„é »ç‡èˆ‡éˆæ„Ÿ..."></textarea>
                    <input type="text" id="tag-input" placeholder="æ¨™ç±¤ (ä»¥ç©ºæ ¼åˆ†éš”)" class="input-gold mb-8">
                    
                    <div class="flex space-x-4">
                        <button onclick="askAI()" class="flex-1 py-4 border border-gold gold-text rounded-full text-xs md:text-sm tracking-widest uppercase hover:bg-stone-50 transition">AI å•Ÿè®€</button>
                        <button onclick="saveEntry()" class="flex-1 py-4 gold-bg text-white rounded-full text-xs md:text-sm tracking-widest uppercase shadow-lg hover:opacity-90 transition">å„²å­˜</button>
                    </div>
                    <p id="ai-response" class="mt-6 text-xs md:text-sm text-gray-500 italic text-center px-4 leading-loose"></p>
                    
                    <div class="text-center mt-10">
                        <button onclick="cancelDraw()" class="text-xs md:text-sm opacity-30 underline uppercase tracking-widest hover:opacity-80 transition p-2">è¿”å›é¦–é </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- === ç‰Œçµ„åº« === -->
        <section id="tab-decks" class="hidden page-transition">
            <div id="deck-list-view">
                <div class="flex justify-between items-center mb-8">
                    <h3 class="text-sm md:text-base gold-text font-bold tracking-widest uppercase">ç‰Œçµ„åº«</h3>
                    <button onclick="showCreateDeck()" class="text-xs md:text-sm underline opacity-50 hover:opacity-100 hover:text-gold transition p-2">ï¼‹ æ–°å¢ç‰Œçµ„</button>
                </div>
                <div id="decks-container" class="space-y-4"></div>
            </div>

            <div id="deck-detail-view" class="hidden">
                <button onclick="hideDeckDetail()" class="text-xs opacity-40 mb-6 uppercase hover:opacity-100 transition p-1">â† è¿”å›åˆ—è¡¨</button>
                <div class="flex justify-between items-end mb-10 border-b border-stone-100 pb-6">
                    <div>
                        <h2 id="current-deck-title" class="text-2xl gold-text italic mb-2">ç‰Œçµ„</h2>
                        <button onclick="editCurrentDeck()" class="text-[11px] md:text-xs opacity-50 underline hover:opacity-100 transition">ä¿®æ”¹ç‰Œçµ„åç¨±</button>
                    </div>
                    <div class="flex flex-col items-end space-y-3">
                        <button onclick="uploadSingleCard()" class="px-5 py-2.5 gold-bg text-white rounded-full text-xs md:text-sm tracking-widest shadow-md active:scale-95 transition hover:opacity-90">
                            ï¼‹ æ–°å¢ç‰Œå¡
                        </button>
                        <button onclick="document.getElementById('batch-upload').click()" class="text-[11px] md:text-xs gold-text underline opacity-70 hover:opacity-100 transition">
                            æˆ–æ‰¹æ¬¡åŒ¯å…¥
                        </button>
                        <input type="file" id="batch-upload" class="hidden" accept="image/*" multiple onchange="handleBatchUpload(this)">
                    </div>
                </div>
                <div id="cards-container" class="grid grid-cols-2 md:grid-cols-3 gap-5 md:gap-6"></div>
                <button onclick="deleteCurrentDeck()" class="w-full mt-24 py-5 text-xs text-red-400 opacity-60 uppercase tracking-widest hover:opacity-100 hover:bg-red-50 rounded-xl transition">ç§»é™¤æ•´å€‹ç‰Œçµ„</button>
            </div>
        </section>

        <!-- === æ­·å²ç´€éŒ„ === -->
        <section id="tab-history" class="hidden page-transition">
            
            <div id="history-main-view">
                <div id="tag-cloud" class="mb-10 w-full border-b border-stone-100 pb-6"></div>
                <div id="history-list" class="space-y-8 md:space-y-10"></div>
            </div>

            <div id="history-edit-view" class="hidden w-full flex-col items-center max-w-lg mx-auto">
                <div class="w-full flex justify-between items-center mb-8 border-b border-stone-100 pb-4">
                    <h3 class="text-sm md:text-base gold-text font-bold tracking-widest uppercase">ä¿®æ”¹ç´€éŒ„</h3>
                    <button onclick="cancelEditHistory()" class="text-xs opacity-40 hover:opacity-100 transition p-1">âœ• å–æ¶ˆ</button>
                </div>
                
                <img id="edit-card-img" src="" class="w-32 md:w-40 aspect-[2/3] object-cover rounded-xl gold-border shadow-sm mb-4">
                <p id="edit-card-name" class="text-sm md:text-base gold-text font-bold mb-10 tracking-wide"></p>

                <div class="w-full px-2 mb-10">
                    <div class="flex justify-between items-end mb-5">
                        <span class="text-xs md:text-sm opacity-50 uppercase tracking-widest">èƒ½é‡å…±æŒ¯é »ç‡</span>
                        <span id="edit-hawkins-display" class="gold-text text-base md:text-lg font-bold tracking-widest transition-all"></span>
                    </div>
                    <div class="relative pt-2 pb-2">
                        <input type="range" id="edit-hawkins-slider" min="0" max="16" class="golden-slider" oninput="updateEditHawkinsDisplay()">
                        <div class="flex justify-between mt-4 text-[10px] md:text-xs opacity-40 tracking-widest">
                            <span>æ”¶ç¸®</span><span>è‡¨ç•Œ</span><span>æ“´å¼µ</span>
                        </div>
                    </div>
                </div>

                <textarea id="edit-diary-text" rows="5" class="w-full p-5 bg-stone-50 border-none rounded-xl text-base focus:ring-1 focus:ring-gold mb-5 leading-loose" placeholder="æ›´æ–°æ‚¨çš„éˆæ„Ÿ..."></textarea>
                <input type="text" id="edit-tag-input" placeholder="æ¨™ç±¤ (ä»¥ç©ºæ ¼åˆ†éš”)" class="input-gold mb-10">
                
                <button onclick="saveEditHistory()" class="w-full py-4 gold-bg text-white rounded-full text-xs md:text-sm tracking-widest uppercase shadow-lg hover:opacity-90 transition active:scale-95">å„²å­˜ä¿®æ”¹</button>
            </div>

        </section>

        <!-- === è¨­å®šå€ === -->
        <section id="tab-settings" class="hidden page-transition space-y-8">
            <h3 class="text-sm md:text-base gold-text font-bold tracking-widest uppercase mb-6">åå¥½è¨­å®š</h3>
            
            <div class="flex flex-col p-6 bg-stone-50 rounded-2xl space-y-4">
                <div class="flex justify-between items-start">
                    <span class="text-sm md:text-base font-bold">AI å°å¸«é‡‘é‘° (API Key)</span>
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-xs md:text-sm gold-text underline p-1">å…è²»ç²å–</a>
                </div>
                <p class="text-xs opacity-60 leading-relaxed">è«‹è¼¸å…¥æ‚¨çš„å°ˆå±¬ Gemini API Key ä»¥å•Ÿç”¨æ™ºèƒ½è§£è®€åŠŸèƒ½ã€‚é‡‘é‘°å°‡å®‰å…¨åœ°å„²å­˜æ–¼æœ¬æ©Ÿè£ç½®ä¸­ã€‚</p>
                <div class="flex items-center space-x-3 mt-4">
                    <input type="password" id="api-key-setting" class="flex-grow bg-white border border-stone-200 rounded-lg p-3 text-sm md:text-base outline-none focus:border-gold transition" placeholder="è¼¸å…¥é‡‘é‘° (AIzaSy...)">
                    <button onclick="saveApiKeySetting()" class="gold-bg text-white px-5 py-3 rounded-lg text-sm whitespace-nowrap hover:opacity-90 transition shadow-sm">å„²å­˜</button>
                </div>
            </div>

            <div class="flex items-center justify-between p-6 bg-stone-50 rounded-2xl mt-6">
                <span class="text-sm md:text-base font-bold">ç´€éŒ„ç•¶å‰æœˆç›¸</span>
                <div onclick="toggleSetting('showLunar')" id="set-lunar" class="toggle-switch cursor-pointer"><div class="toggle-knob"></div></div>
            </div>
            <div class="flex items-center justify-between p-6 bg-stone-50 rounded-2xl">
                <span class="text-sm md:text-base font-bold">ç´€éŒ„ç•¶å‰ç¯€æ°£</span>
                <div onclick="toggleSetting('showSolar')" id="set-solar" class="toggle-switch cursor-pointer"><div class="toggle-knob"></div></div>
            </div>

            <div class="pt-12 border-t border-stone-100 text-center space-y-8">
                <button onclick="exportFullData()" class="text-xs md:text-sm gold-text underline uppercase block w-full hover:opacity-80 transition p-2">å‚™ä»½è³‡æ–™åº« (.JSON)</button>
                <button onclick="document.getElementById('import-full-file').click()" class="text-xs md:text-sm opacity-40 underline uppercase block w-full hover:opacity-80 transition p-2">é‚„åŸè³‡æ–™åº«</button>
                <input type="file" id="import-full-file" class="hidden" accept=".json" onchange="importFullData(this)">
            </div>
            <!-- é—œæ–¼èˆ‡è´ŠåŠ©å€å¡Š -->
            <div class="mt-12 p-8 border border-stone-100 rounded-2xl text-center relative overflow-hidden bg-white">
                <div class="absolute -top-4 -right-4 text-8xl gold-text opacity-5 select-none">âœ§</div>
                <h4 class="text-sm md:text-base font-bold gold-text tracking-widest mb-4">é—œæ–¼ Lumina Journey</h4>
                <p class="text-xs md:text-sm text-stone-500 leading-loose text-left mb-6 relative z-10">
                    é€™å€‹ç©ºé–“çš„èª•ç”Ÿï¼Œæºæ–¼ä¸€å€‹ç°¡å–®çš„é¡˜æœ›ï¼šåœ¨å–§å›‚çš„æ•¸ä½ä¸–ç•Œä¸­ï¼Œä¿ç•™ä¸€è™• 100% éš±ç§ã€ç´”æ·¨ä¸”å……æ»¿ç¾æ„Ÿçš„è§’è½ã€‚è®“æ¯ä¸€æ¬¡çš„æŠ½ç‰Œèˆ‡è¦ºå¯Ÿï¼Œéƒ½èƒ½è¢«æº«æŸ”åœ°æ¥ç´èˆ‡è¨˜éŒ„ã€‚<br><br>å¦‚æœæ‚¨å–œæ­¡é€™è£¡çš„å¯§éœï¼Œæ­¡è¿æ”¯æŒé–‹ç™¼è€…ï¼Œè®“é€™æ®µå…‰ä¹‹æ—…ç¨‹èƒ½èµ°å¾—æ›´é ã€‚
                </p>
                <a href="https://portaly.cc/LuminaJourney/support" target="_blank" class="inline-block w-full py-4 border border-gold gold-text rounded-full text-xs md:text-sm tracking-widest uppercase hover:bg-gold hover:text-white transition relative z-10">
                    â˜•ï¸ æ”¯æŒé–‹ç™¼è€…
                </a>
            </div>
        </section>

    </main>

    <!-- Modal ç³»çµ± -->
    <div id="modal-overlay" class="glass-modal hidden">
        <div id="loading-spinner" class="hidden absolute inset-0 bg-white/90 flex items-center justify-center z-[110]">
            <p class="gold-text animate-pulse text-sm tracking-widest font-bold">é­”æ³•è™•ç†ä¸­...</p>
        </div>
        <div class="w-full max-w-md md:max-w-xl space-y-8 mt-24 px-6">
            <h3 id="modal-title" class="text-center gold-text tracking-widest uppercase text-sm md:text-base font-bold">æ¨™é¡Œ</h3>
            <div id="modal-content" class="w-full"></div>
            <div class="flex space-x-4 w-full pt-4">
                <button id="modal-cancel" onclick="closeModal()" class="flex-1 py-4 text-xs md:text-sm border border-stone-200 rounded-full opacity-60 uppercase hover:bg-stone-50 transition">å–æ¶ˆ</button>
                <button id="modal-confirm" class="flex-1 py-4 gold-bg text-white rounded-full text-xs md:text-sm tracking-widest uppercase shadow-md hover:opacity-90 transition">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <script>
        // --- 0. Hawkins Scale Definition ---
        const hawkinsScale = [
            { v: 20, l: "ç¾æ„§" }, { v: 30, l: "å…§ç–š" }, { v: 50, l: "å†·æ¼ " },
            { v: 75, l: "æ‚²å‚·" }, { v: 100, l: "ææ‡¼" }, { v: 125, l: "æ…¾æœ›" },
            { v: 150, l: "æ†¤æ€’" }, { v: 175, l: "é©•å‚²" }, { v: 200, l: "å‹‡æ°£" },
            { v: 250, l: "æ·¡å®š" }, { v: 310, l: "ä¸»å‹•" }, { v: 350, l: "å¯¬å®¹" },
            { v: 400, l: "ç†æ™º" }, { v: 500, l: "æ„›" }, { v: 540, l: "å–œæ‚…" },
            { v: 600, l: "å¹³å’Œ" }, { v: 700, l: "é–‹æ‚Ÿ" }
        ];

        let activeHawkins = hawkinsScale[8]; 
        let activeEditHawkins = hawkinsScale[8];

        function updateHawkinsDisplay() {
            const slider = document.getElementById('hawkins-slider');
            activeHawkins = hawkinsScale[slider.value];
            const display = document.getElementById('hawkins-display');
            display.innerText = `${activeHawkins.v} ${activeHawkins.l}`;
            
            if (activeHawkins.v < 200) display.className = "text-stone-400 text-base md:text-lg font-bold tracking-widest transition-all";
            else display.className = "gold-text text-base md:text-lg font-bold tracking-widest transition-all";
        }

        function updateEditHawkinsDisplay() {
            const slider = document.getElementById('edit-hawkins-slider');
            activeEditHawkins = hawkinsScale[slider.value];
            const display = document.getElementById('edit-hawkins-display');
            display.innerText = `${activeEditHawkins.v} ${activeEditHawkins.l}`;
            
            if (activeEditHawkins.v < 200) display.className = "text-stone-400 text-base md:text-lg font-bold tracking-widest transition-all";
            else display.className = "gold-text text-base md:text-lg font-bold tracking-widest transition-all";
        }

        // --- 1. Astronomy Logic ---
        const solarTerms = ["å°å¯’","å¤§å¯’","ç«‹æ˜¥","é›¨æ°´","é©šèŸ„","æ˜¥åˆ†","æ¸…æ˜","ç©€é›¨","ç«‹å¤","å°æ»¿","èŠ’ç¨®","å¤è‡³","å°æš‘","å¤§æš‘","ç«‹ç§‹","è™•æš‘","ç™½éœ²","ç§‹åˆ†","å¯’éœ²","éœœé™","ç«‹å†¬","å°é›ª","å¤§é›ª","å†¬è‡³"];
        function getMoonPhase(d) {
            const lp = 2551443, now = new Date(d), new_m = new Date("2000-01-06T18:14:00Z");
            const age = (((now.getTime() - new_m.getTime()) / 1000) % lp) / (24 * 3600);
            if(age < 1.84) return {n:"æ–°æœˆ",i:"ğŸŒ‘"}; if(age < 9.22) return {n:"ä¸Šå¼¦æœˆ",i:"ğŸŒ“"};
            if(age < 16.61) return {n:"æ»¿æœˆ",i:"ğŸŒ•"}; if(age < 23.99) return {n:"ä¸‹å¼¦æœˆ",i:"ğŸŒ—"};
            return {n:"çœ‰æœˆ",i:"ğŸŒ’"};
        }
        function getSolarTerm(d) {
            const y = d.getFullYear(), baseDate = new Date(1900, 0, 6, 2, 5);
            const solarTermInfo = [0, 21208, 42467, 63836, 85337, 107014, 128867, 150921, 173149, 195551, 218072, 240693, 263343, 285989, 308563, 331033, 353350, 375494, 397447, 419210, 440795, 462224, 483532, 504758];
            for(let n=23; n>=0; n--) {
                const off = 31556925974.7*(y-1900) + solarTermInfo[n]*60000;
                if(d >= new Date(baseDate.getTime()+off)) return solarTerms[n];
            }
            return solarTerms[23];
        }

        // --- 2. State & DB ---
        let db, currentDeckId = null, activeCard = null, currentFilter = { type: 'All', value: 'All' }, currentEditId = null;
        let settings = JSON.parse(localStorage.getItem('lumina_settings') || '{"showLunar":true,"showSolar":true}');
        let userApiKey = localStorage.getItem('lumina_api_key') || "";

        const request = indexedDB.open("LuminaJourneyDB_v1", 1);
        request.onupgradeneeded = e => {
            const d = e.target.result;
            d.createObjectStore("decks", {keyPath:"id", autoIncrement:true});
            d.createObjectStore("cards", {keyPath:"id", autoIncrement:true});
        };
        request.onsuccess = e => { db = e.target.result; init(); };

        async function init() {
            if(userApiKey) document.getElementById('api-key-setting').value = userApiKey;
            await ensureDefaultDeck();
            renderDecks();
            updateSettingsUI();
            updateNatureIndicator();
            switchTab('draw');

            // ã€æº«æŸ”çš„å®ˆè­·æé†’ã€‘å»¶é² 1.5 ç§’å¾ŒåŸ·è¡Œï¼Œé¿å…æ‰“æ–·é–‹å ´é«”é©—
            setTimeout(checkBackupReminder, 1500);
        }

        // ã€å…¨æ–°ã€‘å‚™ä»½å®ˆè­·æ©Ÿåˆ¶æ ¸å¿ƒ
        function checkBackupReminder() {
            const history = JSON.parse(localStorage.getItem('lumina_history') || '[]');
            if (history.length === 0) return; // æ²’æœ‰è³‡æ–™å°±ä¸éœ€æé†’

            let lastBackup = localStorage.getItem('lumina_last_backup');
            
            if (!lastBackup) {
                // ç¬¬ä¸€æ¬¡æœ‰è³‡æ–™ä½†æ²’å‚™ä»½éï¼Œè³¦äºˆç•¶ä¸‹æ™‚é–“ä½œç‚ºåŸºæº–é»
                localStorage.setItem('lumina_last_backup', Date.now());
                return;
            }

            // è¨ˆç®—è·é›¢ä¸Šæ¬¡å‚™ä»½æˆ–æé†’ç¶“éäº†å¹¾å¤©
            const daysSince = (Date.now() - parseInt(lastBackup)) / (1000 * 60 * 60 * 24);
            
            if (daysSince >= 7) {
                showBackupReminderModal();
            }
        }

        function showBackupReminderModal() {
            document.getElementById('modal-title').innerText = "éˆæ„Ÿå®ˆè­·æé†’";
            document.getElementById('modal-content').innerHTML = `
                <div class='text-4xl gold-text mb-4 opacity-60 text-center'>âœ§</div>
                <p class='text-center text-sm md:text-base opacity-60 leading-loose'>ç‚ºäº†ä¿è­·æ‚¨çè²´çš„éˆæ„Ÿè»Œè·¡ï¼Œ<br>å»ºè­°æ‚¨å®šæœŸå°‡è³‡æ–™åº«å‚™ä»½è‡³æœ¬æ©Ÿã€‚<br><br>è·é›¢ä¸Šæ¬¡å‚™ä»½å·²è¶…é 7 å¤©ï¼Œ<br>æ˜¯å¦ç¾åœ¨é€²è¡Œå‚™ä»½ï¼Ÿ</p>
            `;
            
            const confirmBtn = document.getElementById('modal-confirm');
            const cancelBtn = document.getElementById('modal-cancel');
            
            confirmBtn.innerText = "ä¸€éµå‚™ä»½";
            confirmBtn.onclick = () => {
                exportFullData(); // é€™è£¡é¢æœƒè‡ªå‹•é‡ç½®æ™‚é–“
                closeModal();
            };
            confirmBtn.classList.remove('hidden');
            
            cancelBtn.innerText = "ç¨å¾Œå†èªª";
            cancelBtn.onclick = () => {
                // é»æ“Šç¨å¾Œå†èªªï¼Œå°‡æ™‚é–“é‡ç½®ç‚º 4 å¤©å‰ï¼ˆç­‰æ–¼å†é 3 å¤©å°±æœƒå†æ¬¡æé†’ï¼‰
                localStorage.setItem('lumina_last_backup', Date.now() - (4 * 24 * 60 * 60 * 1000));
                closeModal();
            };
            
            document.getElementById('modal-overlay').classList.remove('hidden');
        }

        function saveApiKeySetting() {
            const key = document.getElementById('api-key-setting').value.trim();
            localStorage.setItem('lumina_api_key', key);
            userApiKey = key;
            alert("API é‡‘é‘°å·²å®‰å…¨å„²å­˜æ–¼æœ¬æ©Ÿã€‚");
        }

        async function ensureDefaultDeck() {
            const decks = await new Promise(r => db.transaction("decks").objectStore("decks").getAll().onsuccess = e => r(e.target.result));
            let savedId = localStorage.getItem('lumina_default_deck');
            if (decks.length > 0) {
                if (!savedId || !decks.find(d => d.id == savedId)) {
                    localStorage.setItem('lumina_default_deck', decks[0].id);
                }
            }
        }

        // --- 3. UI Navigation ---
        function switchTab(t) {
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('nav > button').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${t}`).classList.remove('hidden');
            document.getElementById(`nav-${t}`).classList.add('active');
            
            if(t==='history') { 
                currentFilter = { type: 'All', value: 'All' }; 
                cancelEditHistory(); 
                renderHistory(); 
            }
            if(t==='draw') updateDrawView();
        }

        function goHome() {
            cancelDraw();
            switchTab('draw');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function updateDrawView() {
            const decks = await new Promise(r => db.transaction("decks").objectStore("decks").getAll().onsuccess = e => r(e.target.result));
            const cards = await new Promise(r => db.transaction("cards").objectStore("cards").getAll().onsuccess = e => r(e.target.result));

            const emptyState = document.getElementById('draw-empty-state');
            const readyView = document.getElementById('draw-ready-view');
            const activeArea = document.getElementById('active-draw-area');

            activeArea.classList.add('hidden');
            document.getElementById('main-card').classList.remove('is-flipped');
            document.getElementById('journal-form').classList.add('opacity-0', 'translate-y-4');

            if (decks.length === 0) {
                emptyState.innerHTML = `
                    <div class="text-4xl gold-text mb-5 opacity-60">âœ§</div>
                    <h2 class="text-2xl md:text-3xl gold-text italic mb-6 tracking-wide">æ­¡è¿ä¾†åˆ° Lumina Journey</h2>
                    <p class="text-sm md:text-base opacity-50 mb-10 leading-loose max-w-xs md:max-w-sm">åœ¨ç•«é¢å±•é–‹çš„ç¬é–“ï¼Œè®“æœªæ›¾å¯Ÿè¦ºçš„å¿ƒè²è¢«ç…§äº®ã€‚<br><br>
                        è«‹å…ˆå»ºç«‹æ‚¨çš„ç¬¬ä¸€å¥—ç‰Œå¡ï¼Œ<br>
                        è®“å®ƒé™ªæ‚¨æ”¶é›†æ—¥å¸¸çš„å¾®å…‰ï¼Œæº«æŸ”è¦ºå¯Ÿæƒ…ç·’çš„æ½®æ±ã€‚</p>
                    <button onclick="switchTab('decks'); showCreateDeck();" class="px-8 py-3.5 border border-gold gold-text rounded-full text-sm tracking-widest uppercase hover:bg-stone-50 transition active:scale-95 shadow-sm">å»ºç«‹å°ˆå±¬ç‰Œçµ„</button>
                `;
                emptyState.classList.remove('hidden');
                readyView.classList.add('hidden');
            } else {
                let defaultId = localStorage.getItem('lumina_default_deck');
                if (!defaultId || !decks.find(d => d.id == defaultId)) {
                    defaultId = decks[0].id;
                    localStorage.setItem('lumina_default_deck', defaultId);
                }
                const deckCards = cards.filter(c => c.deckId == defaultId);

                if (deckCards.length === 0) {
                    const currentDeck = decks.find(d => d.id == defaultId);
                    emptyState.innerHTML = `
                        <div class="text-4xl gold-text mb-5 opacity-60">âœ§</div>
                        <h2 class="text-2xl md:text-3xl gold-text italic mb-6">ç‰Œçµ„å·²å»ºç«‹</h2>
                        <p class="text-sm md:text-base opacity-50 mb-10 leading-loose max-w-xs md:max-w-sm">æ‚¨çš„ã€Œ${currentDeck.title}ã€ç›®å‰é‚„æ˜¯ç©ºçš„ã€‚<br>è«‹åŒ¯å…¥ç‰Œå¡åœ–ç‰‡ï¼Œè³¦äºˆå®ƒéˆé­‚ã€‚</p>
                        <button onclick="switchTab('decks'); showDeckDetail(${defaultId});" class="px-8 py-3.5 border border-gold gold-text rounded-full text-sm tracking-widest uppercase hover:bg-stone-50 transition active:scale-95 shadow-sm">å‰å¾€åŒ¯å…¥ç‰Œå¡</button>
                    `;
                    emptyState.classList.remove('hidden');
                    readyView.classList.add('hidden');
                } else {
                    emptyState.classList.add('hidden');
                    readyView.classList.remove('hidden');
                    document.getElementById('current-deck-name-display').innerText = `ä½¿ç”¨ä¸­ï¼š${decks.find(d => d.id == defaultId).title}`;
                }
            }
        }

        function updateSettingsUI() {
            document.getElementById('set-lunar').className = `toggle-switch cursor-pointer ${settings.showLunar?'on':''}`;
            document.getElementById('set-solar').className = `toggle-switch cursor-pointer ${settings.showSolar?'on':''}`;
        }

        function toggleSetting(k) {
            settings[k] = !settings[k];
            localStorage.setItem('lumina_settings', JSON.stringify(settings));
            updateSettingsUI(); updateNatureIndicator();
        }

        function updateNatureIndicator() {
            const now = new Date();
            let info = "";
            if(settings.showLunar) info += getMoonPhase(now).i + " " + getMoonPhase(now).n;
            if(settings.showSolar) info += (info ? " âœ§ " : "") + getSolarTerm(now);
            document.getElementById('nature-status').innerText = info || "Nature Aligned";
        }

        // --- 4. Deck Logic ---
        async function renderDecks() {
            const container = document.getElementById('decks-container');
            const decks = await new Promise(r => db.transaction("decks").objectStore("decks").getAll().onsuccess = e => r(e.target.result));
            if(decks.length === 0) { container.innerHTML = '<p class="text-center py-16 opacity-30 italic text-sm md:text-base">å°šæœªå»ºç«‹ä»»ä½•ç‰Œçµ„ï¼Œè«‹é»æ“Šå³ä¸Šæ–¹æ–°å¢ã€‚</p>'; return; }
            container.innerHTML = decks.map(d => `<div onclick="showDeckDetail(${d.id})" class="p-6 md:p-8 bg-stone-50 rounded-2xl flex justify-between items-center group active:scale-95 transition cursor-pointer hover:bg-stone-100"><div><h4 class="font-bold text-base md:text-lg mb-2">${d.title}</h4><p class="text-xs opacity-40 uppercase tracking-widest">ç®¡ç†å…§å®¹</p></div><span class="gold-text text-base md:text-lg opacity-0 group-hover:opacity-100 transition-opacity">â†’</span></div>`).join('');
        }

        function showCreateDeck() {
            openModal("å»ºç«‹ç‰Œçµ„ç¨®é¡", `<input type="text" id="deck-name-input" placeholder="ä¾‹å¦‚ï¼šå‰ç‰¹å¡”ç¾…ã€ç¥è«­å¡" class="input-gold">`, async () => {
                const title = document.getElementById('deck-name-input').value;
                if(!title) return;
                const tx = db.transaction("decks", "readwrite");
                const store = tx.objectStore("decks");
                const addReq = store.add({ title, createdAt: Date.now() });
                addReq.onsuccess = (e) => {
                    const newId = e.target.result;
                    if(!localStorage.getItem('lumina_default_deck')) localStorage.setItem('lumina_default_deck', newId);
                    closeModal();
                    showDeckDetail(newId);
                };
            });
        }

        async function showDeckDetail(id) {
            currentDeckId = id;
            document.getElementById('deck-list-view').classList.add('hidden');
            document.getElementById('deck-detail-view').classList.remove('hidden');
            const deck = await new Promise(r => db.transaction("decks").objectStore("decks").get(id).onsuccess = e => r(e.target.result));
            document.getElementById('current-deck-title').innerText = deck.title;
            renderCards();
        }

        function hideDeckDetail() { 
            document.getElementById('deck-list-view').classList.remove('hidden'); 
            document.getElementById('deck-detail-view').classList.add('hidden'); 
            renderDecks(); 
        }
        
        async function renderCards() {
            const container = document.getElementById('cards-container');
            const all = await new Promise(r => db.transaction("cards").objectStore("cards").getAll().onsuccess = e => r(e.target.result));
            const cards = all.filter(c => c.deckId === currentDeckId);
            if(cards.length === 0) { container.innerHTML = '<p class="col-span-2 text-center py-20 opacity-30 italic text-sm">æ­¤ç‰Œçµ„å…§å°šç„¡ç‰Œå¡</p>'; return; }
            container.innerHTML = cards.map(c => `<div class="relative aspect-[2/3] gold-border rounded-xl overflow-hidden shadow-sm cursor-pointer hover:shadow-md transition group" onclick="editCardItem(${c.id})"><img src="${c.image}" class="w-full h-full object-cover group-hover:scale-105 transition duration-500"><div class="absolute bottom-0 w-full bg-white/90 py-3 md:py-4 text-xs md:text-sm text-center gold-text font-bold backdrop-blur-sm truncate px-2">${c.name}</div></div>`).join('');
        }

        async function handleBatchUpload(input) {
            const files = Array.from(input.files);
            if (files.length === 0) return;
            showLoading(true);
            const tx = db.transaction("cards", "readwrite");
            const store = tx.objectStore("cards");
            for (const file of files) {
                const name = file.name.split('.').slice(0, -1).join('.') || "æ–°ç‰Œå¡";
                const base64 = await new Promise(r => {
                    const reader = new FileReader();
                    reader.onload = e => r(e.target.result);
                    reader.readAsDataURL(file);
                });
                store.add({ deckId: currentDeckId, name, image: base64 });
            }
            tx.oncomplete = () => { showLoading(false); renderCards(); input.value = ''; };
        }

        function uploadSingleCard() {
            openModal("æ–°å¢å–®å¼µç‰Œå¡", `<input type="text" id="card-name-input" placeholder="ç‰Œå¡åç¨±" class="input-gold"><input type="file" id="card-file-input" accept="image/*" class="text-xs opacity-50 mt-6 w-full p-2 border border-stone-100 rounded-lg">`, async () => {
                const name = document.getElementById('card-name-input').value, file = document.getElementById('card-file-input').files[0];
                if(!name || !file) return;
                const reader = new FileReader();
                reader.onload = e => {
                    const tx = db.transaction("cards", "readwrite");
                    tx.objectStore("cards").add({ deckId: currentDeckId, name, image: e.target.result });
                    tx.oncomplete = () => { closeModal(); renderCards(); };
                };
                reader.readAsDataURL(file);
            });
        }

        async function editCardItem(id) {
            const card = await new Promise(r => db.transaction("cards").objectStore("cards").get(id).onsuccess = e => r(e.target.result));
            openModal("ç·¨è¼¯ç‰Œå¡", `<div class="flex flex-col items-center"><img src="${card.image}" class="w-24 h-36 md:w-32 md:h-48 object-cover rounded-xl mb-6 gold-border shadow-md"><input type="text" id="edit-card-name" value="${card.name}" class="input-gold"><button onclick="deleteCardItem(${id})" class="mt-8 text-xs text-red-400 opacity-60 uppercase underline hover:opacity-100 transition p-2">ç§»é™¤æ­¤å¼µç‰Œå¡</button></div>`, async () => {
                const newName = document.getElementById('edit-card-name').value;
                const tx = db.transaction("cards", "readwrite");
                tx.objectStore("cards").put({ ...card, name: newName });
                tx.oncomplete = () => { closeModal(); renderCards(); };
            });
        }

        function deleteCardItem(id) { 
            if(confirm("ç¢ºå®šç§»é™¤æ­¤å¡ï¼Ÿ")) { 
                const tx = db.transaction("cards", "readwrite"); 
                tx.objectStore("cards").delete(id); 
                tx.oncomplete = () => { closeModal(); renderCards(); }; 
            } 
        }

        async function editCurrentDeck() {
            const deck = await new Promise(r => db.transaction("decks").objectStore("decks").get(currentDeckId).onsuccess = e => r(e.target.result));
            openModal("ä¿®æ”¹ç‰Œçµ„åç¨±", `<input type="text" id="edit-deck-name" value="${deck.title}" class="input-gold">`, async () => {
                const newTitle = document.getElementById('edit-deck-name').value;
                if(!newTitle) return;
                const tx = db.transaction("decks", "readwrite");
                tx.objectStore("decks").put({ ...deck, title: newTitle });
                tx.oncomplete = () => { document.getElementById('current-deck-title').innerText = newTitle; updateDrawView(); closeModal(); };
            });
        }

        async function deleteCurrentDeck() {
            if(!confirm("ç¢ºå®šåˆªé™¤æ•´å€‹ç‰Œçµ„åŠå…¶æ‰€æœ‰ç‰Œå¡å—ï¼Ÿé€™é …æ“ä½œç„¡æ³•å¾©åŸã€‚")) return;
            const tx = db.transaction(["decks", "cards"], "readwrite");
            tx.objectStore("decks").delete(currentDeckId);
            const cardStore = tx.objectStore("cards");
            const all = await new Promise(r => cardStore.getAll().onsuccess = e => r(e.target.result));
            all.filter(c => c.deckId === currentDeckId).forEach(c => cardStore.delete(c.id));
            
            tx.oncomplete = () => {
                if(localStorage.getItem('lumina_default_deck') == currentDeckId) localStorage.removeItem('lumina_default_deck');
                hideDeckDetail();
            };
        }

        // --- 5. Draw Logic ---
        async function showDeckSwitcher() {
            const decks = await new Promise(r => db.transaction("decks").objectStore("decks").getAll().onsuccess = e => r(e.target.result));
            openModal("åˆ‡æ›ä½¿ç”¨ç‰Œçµ„", `<div class="space-y-3 w-full max-h-[50vh] overflow-y-auto pr-2">${decks.map(d => `<button onclick="setDefaultDeck(${d.id})" class="w-full py-4 border border-stone-100 rounded-xl text-sm hover:border-gold hover:text-gold transition active:scale-95">${d.title}</button>`).join('')}</div>`, null);
        }
        function setDefaultDeck(id) { localStorage.setItem('lumina_default_deck', id); updateDrawView(); closeModal(); }

        async function startDrawRitual() {
            const deckId = localStorage.getItem('lumina_default_deck');
            const all = await new Promise(r => db.transaction("cards").objectStore("cards").getAll().onsuccess = e => r(e.target.result));
            const deckCards = all.filter(c => c.deckId == deckId);
            activeCard = deckCards[Math.floor(Math.random() * deckCards.length)];
            prepareRecordView(true);
        }

        async function openManualSelectModal() {
            const deckId = localStorage.getItem('lumina_default_deck');
            const all = await new Promise(r => db.transaction("cards").objectStore("cards").getAll().onsuccess = e => r(e.target.result));
            const deckCards = all.filter(c => c.deckId == deckId);
            
            const gridHtml = `
                <div class="grid grid-cols-3 md:grid-cols-4 gap-4 max-h-[60vh] overflow-y-auto p-1 w-full">
                    ${deckCards.map(c => `
                        <div onclick='selectManualCard(${JSON.stringify(c).replace(/'/g, "&apos;")})' class="cursor-pointer hover:opacity-80 transition active:scale-95 flex flex-col items-center">
                            <img src="${c.image}" class="w-full aspect-[2/3] object-cover rounded-lg gold-border shadow-sm mb-2">
                            <p class="text-[10px] md:text-xs text-center truncate gold-text w-full px-1">${c.name}</p>
                        </div>
                    `).join('')}
                </div>`;
            openModal("è‡ªè¡Œé¸ç‰Œç´€éŒ„", gridHtml, null);
        }

        function selectManualCard(card) {
            closeModal();
            activeCard = card;
            prepareRecordView(false);
        }

        function prepareRecordView(isRandomDraw) {
            document.getElementById('drawn-img').src = activeCard.image;
            document.getElementById('drawn-name').innerText = activeCard.name;
            document.getElementById('diary-text').value = "";
            document.getElementById('tag-input').value = "";
            document.getElementById('ai-response').innerText = "";
            
            document.getElementById('hawkins-slider').value = 8;
            updateHawkinsDisplay();
            
            document.getElementById('draw-empty-state').classList.add('hidden');
            document.getElementById('draw-ready-view').classList.add('hidden');
            document.getElementById('active-draw-area').classList.remove('hidden');
            
            const mainCard = document.getElementById('main-card');
            const journalForm = document.getElementById('journal-form');
            
            if(isRandomDraw) {
                mainCard.classList.remove('is-flipped');
                journalForm.classList.add('opacity-0', 'translate-y-4');
                setTimeout(() => flipCard(), 150);
            } else {
                mainCard.classList.add('is-flipped');
                journalForm.classList.remove('opacity-0', 'translate-y-4');
            }
        }

        function flipCard() { 
            const el = document.getElementById('main-card'); 
            if(el.classList.contains('is-flipped')) return; 
            el.classList.add('is-flipped'); 
            triggerSparkles(); 
            setTimeout(() => document.getElementById('journal-form').classList.remove('opacity-0', 'translate-y-4'), 600); 
        }

        function cancelDraw() { 
            updateDrawView();
        }

        async function saveEntry() {
            const content = document.getElementById('diary-text').value;
            const tagVal = document.getElementById('tag-input').value;
            if(!content) return alert("è«‹å¯«ä¸‹ä½ æŠ½åˆ°çš„ç‰Œå¡å’Œæ„Ÿæ‚Ÿ");
            
            const now = new Date();
            const tags = tagVal.split(/[\s,ï¼Œ]+/).filter(t => t.trim() !== "");
            
            const entry = {
                id: Date.now(), 
                cardName: activeCard.name, 
                cardImg: activeCard.image,
                content: content, 
                tags: tags,
                hawkins: activeHawkins,
                ai: document.getElementById('ai-response').innerText,
                date: now.toLocaleString('zh-TW', { hour12: false }),
                lunar: settings.showLunar ? getMoonPhase(now) : null, 
                solar: settings.showSolar ? getSolarTerm(now) : null
            };
            
            const history = JSON.parse(localStorage.getItem('lumina_history') || '[]');
            history.unshift(entry);
            localStorage.setItem('lumina_history', JSON.stringify(history));
            
            openModal("å„²å­˜æˆåŠŸ", "<p class='text-center text-sm opacity-60'>æ„Ÿæ‚Ÿå·²å®‰æ”¾æ–¼æ™‚é–“çš„é•·æ²³ä¸­ã€‚</p>", () => {
                cancelDraw();
                switchTab('history');
                closeModal();
            });
        }

        // --- 6. History Management ---
        function renderHistory() {
            const history = JSON.parse(localStorage.getItem('lumina_history') || '[]');
            const list = document.getElementById('history-list');
            const cloud = document.getElementById('tag-cloud');
            
            if(history.length === 0) { 
                cloud.innerHTML = '';
                list.innerHTML = '<p class="text-center py-20 opacity-30 italic text-sm md:text-base">å°šç„¡ç›¸é—œç´€éŒ„ï¼Œè«‹å…ˆå‰å¾€ä»Šæ—¥æŠ½ç‰Œã€‚</p>'; 
                return; 
            }

            const moonsMap = {};
            const tagCounts = {};
            history.forEach(h => {
                if(h.lunar) moonsMap[h.lunar.n] = h.lunar.i;
                (h.tags || []).forEach(t => tagCounts[t] = (tagCounts[t] || 0) + 1);
            });
            
            const availableMoons = Object.keys(moonsMap);
            const topTags = Object.entries(tagCounts).sort((a,b) => b[1] - a[1]).slice(0, 3).map(e => e[0]);
            
            let cloudHtml = `<button onclick="filterBy('All', 'All')" class="tag-filter whitespace-nowrap flex-shrink-0 ${currentFilter.type==='All'?'active':''} hover:bg-gold hover:text-white transition">å…¨éƒ¨ç´€éŒ„</button>`;
            
            if (availableMoons.length > 0) {
                cloudHtml += `<div class="w-px h-4 bg-stone-200 flex-shrink-0 mx-2"></div>`;
                cloudHtml += availableMoons.map(m => `<button onclick="filterBy('moon', '${m}')" class="tag-filter whitespace-nowrap flex-shrink-0 ${currentFilter.type==='moon' && currentFilter.value===m ?'active':''} hover:bg-gold hover:text-white transition">${moonsMap[m]} ${m}</button>`).join('');
            }
            if (topTags.length > 0) {
                cloudHtml += `<div class="w-px h-4 bg-stone-200 flex-shrink-0 mx-2"></div>`;
                cloudHtml += topTags.map(t => `<button onclick="filterBy('tag', '${t}')" class="tag-filter whitespace-nowrap flex-shrink-0 ${currentFilter.type==='tag' && currentFilter.value===t ?'active':''} hover:bg-gold hover:text-white transition">#${t}</button>`).join('');
            }
            
            cloud.innerHTML = `<p class="text-[10px] md:text-xs opacity-40 tracking-widest mb-4 uppercase text-center w-full">æ´å¯Ÿç¯©é¸å™¨</p><div class="filter-scroll-container">${cloudHtml}</div>`;

            const filtered = currentFilter.type === 'All' ? history :
                             currentFilter.type === 'moon' ? history.filter(h => h.lunar && h.lunar.n === currentFilter.value) :
                             history.filter(h => (h.tags || []).includes(currentFilter.value));

            if(filtered.length === 0) { list.innerHTML = '<p class="text-center py-20 opacity-30 italic text-sm">æ­¤æ¨™ç±¤ä¸‹ç„¡ç´€éŒ„</p>'; return; }
            
            list.innerHTML = filtered.map(h => {
                const natureInfo = [(h.lunar ? `${h.lunar.i} ${h.lunar.n}` : ""), (h.solar ? `âœ§ ${h.solar}` : "")].filter(Boolean).join(" ");
                
                let auraImgClass = "border-stone-200";
                let auraRowClass = "border-stone-100 pl-5";
                let textClass = "gold-text";

                if (h.hawkins.v < 200) {
                    auraImgClass = "aura-low-img";
                    textClass = "text-stone-400";
                } else if (h.hawkins.v >= 500) {
                    auraImgClass = "border-gold"; 
                    auraRowClass = "aura-high-row pl-4"; 
                    textClass = "gold-text";
                }

                return `
                <div class="flex space-x-5 md:space-x-8 relative animate-fade-in border-l ${auraRowClass} py-3 pr-2">
                    
                    <div class="w-20 md:w-28 flex-shrink-0 flex flex-col items-center">
                        <img src="${h.cardImg}" class="w-full aspect-[2/3] object-cover rounded-lg border transition-all duration-500 shadow-sm ${auraImgClass}">
                        <span class="${textClass} text-[10px] md:text-xs font-bold mt-3 text-center leading-tight w-full break-words tracking-wide">${h.cardName}</span>
                    </div>

                    <div class="flex-grow pt-1">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex flex-col text-[10px] md:text-xs opacity-50 space-y-1">
                                <span>${h.date}</span>
                                <span>${natureInfo}</span>
                            </div>
                            
                            <div class="flex space-x-3 -mt-1 -mr-1">
                                <button onclick="editJournalEntry(${h.id})" class="text-xs md:text-sm opacity-30 hover:opacity-100 hover:text-gold transition p-1 cursor-pointer" title="ç·¨è¼¯ç´€éŒ„">âœ ä¿®æ”¹</button>
                                <button onclick="deleteJournalEntry(${h.id})" class="text-xs md:text-sm opacity-30 hover:opacity-100 hover:text-red-400 transition p-1 cursor-pointer" title="åˆªé™¤ç´€éŒ„">Ã— åˆªé™¤</button>
                            </div>
                        </div>
                        
                        <p class="text-[11px] md:text-xs opacity-60 tracking-widest mb-3 flex items-center">
                            <span class="mr-2 opacity-70">èƒ½é‡:</span> 
                            <span class="${textClass} font-bold">${h.hawkins.v} ${h.hawkins.l}</span>
                        </p>
                        
                        <p class="text-sm md:text-base text-stone-700 leading-loose mb-4">${h.content}</p>
                        
                        <div class="mb-3">${(h.tags || []).map(t => `<span class="tag-chip">#${t}</span>`).join('')}</div>
                        ${h.ai ? `<div class="bg-stone-50 p-4 rounded-xl text-xs md:text-sm italic text-stone-500 mb-1 leading-loose">AI å°å¸«ï¼š${h.ai}</div>` : ''}
                    </div>
                </div>
                `;
            }).join('');
        }

        function filterBy(type, value) { currentFilter = { type, value }; renderHistory(); }

        function editJournalEntry(id) {
            const history = JSON.parse(localStorage.getItem('lumina_history') || '[]');
            const entry = history.find(h => h.id === id);
            currentEditId = id; 
            
            document.getElementById('edit-card-img').src = entry.cardImg;
            document.getElementById('edit-card-name').innerText = entry.cardName;
            document.getElementById('edit-diary-text').value = entry.content;
            document.getElementById('edit-tag-input').value = (entry.tags || []).join(' ');
            
            let sIdx = hawkinsScale.findIndex(x => x.v === entry.hawkins.v);
            document.getElementById('edit-hawkins-slider').value = sIdx !== -1 ? sIdx : 8;
            updateEditHawkinsDisplay();
            
            document.getElementById('history-main-view').classList.add('hidden');
            document.getElementById('history-edit-view').classList.remove('hidden');
            document.getElementById('history-edit-view').classList.add('flex');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function cancelEditHistory() {
            currentEditId = null;
            document.getElementById('history-edit-view').classList.add('hidden');
            document.getElementById('history-edit-view').classList.remove('flex');
            document.getElementById('history-main-view').classList.remove('hidden');
        }

        function saveEditHistory() {
            const content = document.getElementById('edit-diary-text').value;
            const tagVal = document.getElementById('edit-tag-input').value;
            if(!content) return alert("è«‹å¯«ä¸‹ä½ æŠ½åˆ°çš„ç‰Œå¡å’Œæ„Ÿæ‚Ÿ");
            
            const history = JSON.parse(localStorage.getItem('lumina_history') || '[]');
            const idx = history.findIndex(h => h.id === currentEditId);
            
            if (idx !== -1) {
                history[idx].content = content;
                history[idx].tags = tagVal.split(/[\s,ï¼Œ]+/).filter(t => t.trim() !== "");
                history[idx].hawkins = activeEditHawkins;
                localStorage.setItem('lumina_history', JSON.stringify(history));
                
                cancelEditHistory();
                renderHistory();
            }
        }

        function deleteJournalEntry(id) {
            openModal("åˆªé™¤ç´€éŒ„", "<p class='text-center text-sm opacity-60'>ç¢ºå®šè¦å°‡é€™ä»½ç´€éŒ„åˆªé™¤å—ï¼Ÿ<br>æ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚</p>", () => {
                let history = JSON.parse(localStorage.getItem('lumina_history') || '[]');
                history = history.filter(h => h.id !== id);
                localStorage.setItem('lumina_history', JSON.stringify(history));
                renderHistory();
                closeModal();
            });
        }

        // --- 7. AI & Modals ---
        async function askAI() {
            if (!userApiKey) {
                alert("å®‡å®™çš„è¯ç¹«éœ€è¦ä¸€æŠŠé‘°åŒ™ã€‚\n\nè«‹å…ˆå‰å¾€ã€Œè¨­å®šã€é é¢ï¼Œè¼¸å…¥æ‚¨çš„ Gemini API Key ä¾†å–šé†’ AI å°å¸«ã€‚");
                switchTab('settings');
                return;
            }

            const box = document.getElementById('ai-response'); 
            box.innerText = "æ­£åœ¨æ„Ÿæ‡‰æ˜Ÿè¾°...";
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userApiKey}`, {
                    method:'POST', body: JSON.stringify({contents:[{parts:[{text:`ä½ æ˜¯ä¸€ä½å„ªé›…çš„å¿ƒéˆå°å¸«ã€‚ä½¿ç”¨è€…åœ¨éœé‡‘æ–¯èƒ½é‡å±¤ç´š ${activeHawkins.v} (${activeHawkins.l}) çš„ç‹€æ…‹ä¸‹æŠ½åˆ°äº†ã€Œ${activeCard.name}ã€ã€‚è«‹çµ¦ä¸€æ®µç´„ 60 å­—çš„æº«æš–å•Ÿç™¼ã€‚`}]}]})
                });
                
                if (!res.ok) throw new Error("API Error");

                const data = await res.json();
                box.innerText = data.candidates?.[0]?.content?.parts?.[0]?.text || "è†è½ä½ çš„ç›´è¦ºï¼Œç•¶ä¸‹å³æ˜¯ç­”æ¡ˆã€‚";
            } catch(e) { 
                box.innerText = "å®‡å®™æš«æ™‚éœé»˜ï¼Œè«‹ç¢ºèªæ‚¨çš„ API Key æ˜¯å¦æ­£ç¢ºã€‚"; 
            }
        }

        // ä¿®æ”¹å¾Œçš„å½ˆçª—ç³»çµ±ï¼Œèƒ½ç¢ºä¿æŒ‰éˆ•æ–‡å­—åœ¨æ¯æ¬¡å‘¼å«å¾Œé‡ç½®
        function openModal(title, content, confirmFn) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-content').innerHTML = content;
            const confirmBtn = document.getElementById('modal-confirm');
            const cancelBtn = document.getElementById('modal-cancel');
            
            // é‡ç½®ç‚ºé è¨­æ–‡å­—
            confirmBtn.innerText = "ç¢ºå®š";
            cancelBtn.innerText = "é—œé–‰";
            cancelBtn.onclick = closeModal;
            
            if (confirmFn) {
                confirmBtn.onclick = confirmFn;
                confirmBtn.classList.remove('hidden');
                cancelBtn.innerText = "å–æ¶ˆ";
            } else {
                confirmBtn.classList.add('hidden');
            }
            document.getElementById('modal-overlay').classList.remove('hidden');
        }
        function closeModal() { document.getElementById('modal-overlay').classList.add('hidden'); }
        function showLoading(show) { document.getElementById('loading-spinner').classList.toggle('hidden', !show); }

        function triggerSparkles() {
            const canvas = document.getElementById('sparkle-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            let particles = [];
            for(let i=0; i<40; i++) particles.push({x:window.innerWidth/2, y:window.innerHeight/3, vx:(Math.random()-0.5)*12, vy:(Math.random()-0.5)*12, s:Math.random()*2.5, a:1});
            function anim() {
                ctx.clearRect(0,0,canvas.width,canvas.height);
                particles.forEach((p,i) => {
                    p.x+=p.vx; p.y+=p.vy; p.a-=0.02; ctx.fillStyle=`rgba(212,175,55,${p.a})`;
                    ctx.beginPath(); ctx.arc(p.x, p.y, p.s, 0, Math.PI*2); ctx.fill();
                    if(p.a<=0) particles.splice(i,1);
                });
                if(particles.length > 0) requestAnimationFrame(anim);
            }
            anim();
        }

        async function exportFullData() {
            showLoading(true);
            const decks = await new Promise(r => db.transaction("decks").objectStore("decks").getAll().onsuccess = e => r(e.target.result));
            const cards = await new Promise(r => db.transaction("cards").objectStore("cards").getAll().onsuccess = e => r(e.target.result));
            const history = JSON.parse(localStorage.getItem('lumina_history') || '[]');
            const blob = new Blob([JSON.stringify({ decks, cards, history })], { type: "application/json" });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `lumina_journey_backup_${Date.now()}.json`; a.click();
            
            // ã€æ–°å¢ã€‘æ¯æ¬¡æˆåŠŸå‚™ä»½å¾Œï¼Œé‡ç½®å®ˆè­·æé†’çš„è¨ˆç®—æ™‚é–“
            localStorage.setItem('lumina_last_backup', Date.now());
            
            showLoading(false);
        }

        function importFullData(input) {
            if(!input.files[0]) return;
            showLoading(true);
            const r = new FileReader();
            r.onload = async e => {
                try {
                    const data = JSON.parse(e.target.result);
                    const tx = db.transaction(["decks", "cards"], "readwrite");
                    if(data.decks) data.decks.forEach(d => tx.objectStore("decks").put(d));
                    if(data.cards) data.cards.forEach(c => tx.objectStore("cards").put(c));
                    if(data.history) localStorage.setItem('lumina_history', JSON.stringify(data.history));
                    tx.oncomplete = () => {
                        showLoading(false);
                        alert("è³‡æ–™é‚„åŸæˆåŠŸï¼");
                        location.reload();
                    };
                } catch(err) {
                    showLoading(false);
                    alert("æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼Œé‚„åŸå¤±æ•—ã€‚");
                }
            };
            r.readAsText(input.files[0]);
        }
    </script>
</body>
</html>


